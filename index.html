<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Telemetry Dashboard</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Prop Types (Required by Recharts) -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Recharts for Charts (Pinned Version) -->
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    
    <!-- PapaParse for CSV Processing -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap');

        body { 
            background-color: #09090b; 
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif; 
            background-image: 
                radial-gradient(at 0% 0%, rgba(220, 38, 38, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(37, 99, 235, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
        }
        
        h1, h2, h3, h4, h5, h6, .font-display { font-family: 'Chakra Petch', sans-serif; }
        .font-mono { font-family: 'Chakra Petch', monospace; }
        
        /* Modern Card */
        .card { 
            background-color: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            border-radius: 0.75rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card:hover {
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: translateY(-2px);
        }

        .scroll-hide::-webkit-scrollbar { width: 6px; height: 6px; }
        .scroll-hide::-webkit-scrollbar-track { background: transparent; }
        .scroll-hide::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .scroll-hide::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .f1-red-text { color: #ef4444; }
        
        .loading-spinner { 
            border: 2px solid rgba(255,255,255,0.1); 
            border-left-color: #ef4444; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            animation: spin 0.8s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Recharts Tooltip */
        .custom-tooltip {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 8px 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
        }
        
        .nav-item.active {
            color: #fff;
            border-bottom: 2px solid #ef4444;
        }
        .nav-item {
            color: #94a3b8;
            border-bottom: 2px solid transparent;
        }
        .nav-item:hover {
            color: #cbd5e1;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        
        const { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, 
            LineChart, Line, PieChart, Pie, Cell, Radar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis,
            Area, AreaChart
        } = window.Recharts || {};

        // --- ICONS ---
        const Icons = {
            Flag: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></svg>,
            Users: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Wrench: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
            Trophy: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
            Database: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            Server: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="8" x="2" y="2" rx="2" ry="2"/><rect width="20" height="8" x="2" y="14" rx="2" ry="2"/><line x1="6" x2="6.01" y1="6" y2="6"/><line x1="6" x2="6.01" y1="18" y2="18"/></svg>,
            MousePointer2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="M13 13l6 6"/></svg>,
            Calendar: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            Swords: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/></svg>,
            Activity: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Archive: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="5" x="2" y="4" rx="2"/><path d="M4 9v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9"/><path d="M10 13h4"/></svg>
        };

        // --- INITIAL DATA (2023 Final) ---
        const INITIAL_DATA = {
            drivers: {
                "1": { name: "Lewis Hamilton", nat: "British" },
                "830": { name: "Max Verstappen", nat: "Dutch" },
                "4": { name: "Fernando Alonso", nat: "Spanish" },
                "844": { name: "Charles Leclerc", nat: "Monegasque" },
                "832": { name: "Carlos Sainz", nat: "Spanish" },
                "846": { name: "Lando Norris", nat: "British" },
                "815": { name: "Sergio Perez", nat: "Mexican" }
            },
            teams: {
                "9": { name: "Red Bull", nat: "Austrian" },
                "131": { name: "Mercedes", nat: "German" },
                "6": { name: "Ferrari", nat: "Italian" },
                "1": { name: "McLaren", nat: "British" },
                "117": { name: "Aston Martin", nat: "British" }
            },
            driverStats: {
                "830": { wins: 19, pods: 21, races: 22, pts: 575, poles: 12, dnfs: 0, scored: 22 },
                "815": { wins: 2, pods: 9, races: 22, pts: 285, poles: 2, dnfs: 2, scored: 20 },
                "1": { wins: 0, pods: 6, races: 22, pts: 234, poles: 1, dnfs: 1, scored: 21 },
                "4": { wins: 0, pods: 8, races: 22, pts: 206, poles: 0, dnfs: 2, scored: 20 },
                "844": { wins: 0, pods: 6, races: 22, pts: 206, poles: 5, dnfs: 3, scored: 19 },
                "846": { wins: 0, pods: 7, races: 22, pts: 205, poles: 0, dnfs: 1, scored: 21 },
                "832": { wins: 1, pods: 3, races: 22, pts: 200, poles: 2, dnfs: 2, scored: 20 }
            },
            teamStats: {
                "9": { wins: 21, pods: 30, races: 44, pts: 860, poles: 14, dnfs: 2, scored: 42 },
                "131": { wins: 0, pods: 8, races: 44, pts: 409, poles: 1, dnfs: 4, scored: 40 },
                "6": { wins: 1, pods: 9, races: 44, pts: 406, poles: 7, dnfs: 5, scored: 39 },
                "1": { wins: 0, pods: 9, races: 44, pts: 302, poles: 0, dnfs: 4, scored: 40 },
                "117": { wins: 0, pods: 8, races: 44, pts: 280, poles: 0, dnfs: 6, scored: 38 }
            },
            seasons: {
                "2023": { 
                    year: 2023, races: 22, driverChampId: "830", teamChampId: "9",
                    driverStandings: { "830": 575, "815": 285, "1": 234, "4": 206, "844": 206 },
                    teamStandings: { "9": 860, "131": 409, "6": 406, "1": 302, "117": 280 },
                    raceOrder: ["Bahrain","Saudi","Aus","Azer","Miami","Monaco","Spain","Canada","Austria","GB","Hungary","Belgium","Ned","Italy","Sing","Japan","Qatar","USA","Mexico","Brazil","Vegas","Abu Dhabi"],
                    pointsHistory: {
                        "830": [25,44,69,93,119,144,170,195,229,255,281,314,339,364,374,400,433,466,491,524,549,575],
                        "815": [18,43,54,87,105,105,117,126,148,156,171,189,201,219,223,223,224,240,240,258,273,285]
                    }
                }
            },
            recentResults: [
                { race: "Abu Dhabi GP", year: 2023, winner: "830", team: "9" },
                { race: "Las Vegas GP", year: 2023, winner: "830", team: "9" },
                { race: "SÃ£o Paulo GP", year: 2023, winner: "830", team: "9" }
            ],
            retirementCauses: [
                { name: "Accident", value: 45 },
                { name: "Mechanical", value: 32 },
                { name: "Other", value: 12 }
            ],
            yearlyStats: {} // Stores stats per year
        };

        const COLORS = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#a855f7'];
        const PIE_COLORS = ['#ef4444', '#334155', '#475569', '#64748b', '#94a3b8'];

        // --- DATA FETCHER ---
        const DataFetcher = ({ onDataLoaded }) => {
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState("");
            const [logs, setLogs] = useState([]);

            const BASE_URL = "https://raw.githubusercontent.com/s-harish44/F1/87a8f047ff158f87696fd2e4c2a47da43dd256c9/Datasets/";
            
            const filesToFetch = [
                "Driver_Details.csv", "Team_Details.csv", "Race_Results.csv", "Race_Schedule.csv",
                "Qualifying_Results.csv", "Race_Status.csv", "Sprint_Race_Results.csv", "Pit_Stop_Records.csv"
            ];

            const addLog = (msg) => setLogs(prev => [...prev, `> ${msg}`]);

            const fetchAndProcess = async () => {
                setLoading(true);
                setError("");
                setLogs(["> Initializing secure connection...", "> Resolving endpoints...", "> Handshaking with database node..."]);
                
                await new Promise(r => setTimeout(r, 800));

                const fetchedData = {};

                try {
                    const fetchPromises = filesToFetch.map(fileName => {
                        return new Promise((resolve, reject) => {
                            Papa.parse(BASE_URL + fileName, {
                                download: true, header: true, skipEmptyLines: true,
                                complete: (results) => {
                                    fetchedData[fileName] = results.data;
                                    addLog(`Latched: ${fileName.split('.')[0]}_Table [${results.data.length} rows]`);
                                    resolve();
                                },
                                error: (err) => reject(`Sync failed: ${fileName}`)
                            });
                        });
                    });

                    await Promise.all(fetchPromises);
                    addLog("Compiling analytics...");

                    // --- DATA PROCESSING ---
                    const data = {};
                    const driversRaw = fetchedData["Driver_Details.csv"];
                    const teamsRaw = fetchedData["Team_Details.csv"];
                    const resultsRaw = fetchedData["Race_Results.csv"];
                    const scheduleRaw = fetchedData["Race_Schedule.csv"];
                    const qualiRaw = fetchedData["Qualifying_Results.csv"];
                    const statusRaw = fetchedData["Race_Status.csv"];
                    const sprintRaw = fetchedData["Sprint_Race_Results.csv"];
                    const pitRaw = fetchedData["Pit_Stop_Records.csv"];

                    data.drivers = {};
                    driversRaw.forEach(r => data.drivers[r.driverId] = { name: `${r.forename} ${r.surname}`, nat: r.nationality });

                    data.teams = {};
                    teamsRaw.forEach(r => data.teams[r.constructorId] = { name: r.name, nat: r.nationality });

                    const statusMap = {};
                    statusRaw.forEach(r => statusMap[r.statusId] = r.status);

                    data.driverStats = {}; 
                    data.teamStats = {};   
                    data.yearlyStats = {}; 
                    data.recentResults = [];
                    data.seasons = {};
                    data.retirementCauses = {}; 

                    const initStats = () => ({ wins: 0, pods: 0, races: 0, pts: 0, poles: 0, dnfs: 0, scored: 0, pitAvg: 0, pitCount: 0 });
                    
                    const getStatObj = (target, id) => {
                        if (!target[id]) target[id] = initStats();
                        return target[id];
                    };

                    const getYearlyStat = (year, type, id) => {
                        if (!data.yearlyStats[year]) data.yearlyStats[year] = { driverStats: {}, teamStats: {}, retirementCauses: {} };
                        const target = type === 'driver' ? data.yearlyStats[year].driverStats : data.yearlyStats[year].teamStats;
                        return getStatObj(target, id);
                    };

                    const updateRetirement = (targetObj, statusText) => {
                        let causeGroup = "Other";
                        const sLower = statusText.toLowerCase();
                        if (sLower.includes("accident") || sLower.includes("collision")) causeGroup = "Accident";
                        else if (sLower.includes("engine") || sLower.includes("gearbox") || sLower.includes("hydraulics")) causeGroup = "Mechanical";
                        targetObj[causeGroup] = (targetObj[causeGroup] || 0) + 1;
                    };

                    // 1. Build Timeline
                    const scheduleMap = {}; 
                    const seasonHelper = {}; 
                    scheduleRaw.sort((a, b) => new Date(a.date) - new Date(b.date));

                    scheduleRaw.forEach(r => {
                        const y = parseInt(r.year);
                        scheduleMap[r.raceId] = { year: y, name: r.name, date: r.date };
                        if (!seasonHelper[y]) seasonHelper[y] = { raceCount: new Set(), pointsHistory: {}, raceOrder: [] };
                        if (!seasonHelper[y].raceOrder.includes(r.name)) seasonHelper[y].raceOrder.push(r.name);
                    });

                    // 2. Process Qualifying
                    qualiRaw.forEach(q => {
                        if (parseInt(q.position) === 1) {
                            getStatObj(data.driverStats, q.driverId).poles += 1;
                            getStatObj(data.teamStats, q.constructorId).poles += 1;
                            if (scheduleMap[q.raceId]) {
                                const y = scheduleMap[q.raceId].year;
                                getYearlyStat(y, 'driver', q.driverId).poles += 1;
                                getYearlyStat(y, 'team', q.constructorId).poles += 1;
                            }
                        }
                    });

                    // 3. Process Pit Stops
                    const resLookup = {}; 
                    resultsRaw.forEach(r => resLookup[`${r.raceId}-${r.driverId}`] = r.constructorId);
                    
                    pitRaw.forEach(p => {
                        const dur = parseFloat(p.duration);
                        if (dur && dur < 30) { 
                            const cid = resLookup[`${p.raceId}-${p.driverId}`];
                            if (cid) {
                                const ts = getStatObj(data.teamStats, cid);
                                ts.pitAvg = ((ts.pitAvg * ts.pitCount) + dur) / (ts.pitCount + 1);
                                ts.pitCount += 1;
                                if (scheduleMap[p.raceId]) {
                                    const y = scheduleMap[p.raceId].year;
                                    const yts = getYearlyStat(y, 'team', cid);
                                    yts.pitAvg = ((yts.pitAvg * yts.pitCount) + dur) / (yts.pitCount + 1);
                                    yts.pitCount += 1;
                                }
                            }
                        }
                    });

                    // 4. Process Sprints
                    sprintRaw.forEach(s => {
                        const pts = parseFloat(s.points) || 0;
                        const did = s.driverId;
                        const cid = s.constructorId;
                        const rid = s.raceId;

                        const ds = getStatObj(data.driverStats, did);
                        const ts = getStatObj(data.teamStats, cid);
                        ds.pts += pts; ts.pts += pts;
                        if (pts > 0) { ds.scored += 1; ts.scored += 1; }

                        if (scheduleMap[rid]) {
                            const y = scheduleMap[rid].year;
                            const raceName = scheduleMap[rid].name;
                            const raceIdx = seasonHelper[y].raceOrder.indexOf(raceName);

                            const yds = getYearlyStat(y, 'driver', did);
                            const yts = getYearlyStat(y, 'team', cid);
                            yds.pts += pts; yts.pts += pts;
                            if (pts > 0) { yds.scored += 1; yts.scored += 1; }

                            if (seasonHelper[y] && raceIdx !== -1) {
                                if (!seasonHelper[y].pointsHistory[did]) seasonHelper[y].pointsHistory[did] = new Array(seasonHelper[y].raceOrder.length).fill(0);
                                seasonHelper[y].pointsHistory[did][raceIdx] += pts;
                            }
                        }
                    });

                    // 5. Process Main Races
                    resultsRaw.forEach(r => {
                        const did = r.driverId;
                        const cid = r.constructorId;
                        const pos = parseInt(r.position); 
                        const pts = parseFloat(r.points) || 0;
                        const rid = r.raceId;
                        const sid = r.statusId;

                        const ds = getStatObj(data.driverStats, did);
                        const ts = getStatObj(data.teamStats, cid);
                        ds.races += 1; ts.races += 1;
                        ds.pts += pts; ts.pts += pts;
                        if (pts > 0) { ds.scored += 1; ts.scored += 1; }
                        if (pos === 1) { ds.wins += 1; ts.wins += 1; }
                        if (pos <= 3) { ds.pods += 1; ts.pods += 1; }

                        const statusText = statusMap[sid] || "Unknown";
                        const isFinished = statusText === "Finished" || statusText.includes("+");
                        if (!isFinished) {
                            ds.dnfs += 1; ts.dnfs += 1;
                            updateRetirement(data.retirementCauses, statusText);
                        }

                        if (scheduleMap[rid]) {
                            const y = scheduleMap[rid].year;
                            const raceName = scheduleMap[rid].name;
                            const raceIdx = seasonHelper[y].raceOrder.indexOf(raceName);

                            const yds = getYearlyStat(y, 'driver', did);
                            const yts = getYearlyStat(y, 'team', cid);
                            
                            yds.races += 1; yts.races += 1;
                            yds.pts += pts; yts.pts += pts;
                            if (pts > 0) { yds.scored += 1; yts.scored += 1; }
                            if (pos === 1) { yds.wins += 1; yts.wins += 1; }
                            if (pos <= 3) { yds.pods += 1; yts.pods += 1; }
                            
                            if (!isFinished) {
                                yds.dnfs += 1; yts.dnfs += 1;
                                if (!data.yearlyStats[y].retirementCauses) data.yearlyStats[y].retirementCauses = {};
                                updateRetirement(data.yearlyStats[y].retirementCauses, statusText);
                            }

                            if (seasonHelper[y]) {
                                seasonHelper[y].raceCount.add(rid);
                                if (raceIdx !== -1) {
                                    if (!seasonHelper[y].pointsHistory[did]) seasonHelper[y].pointsHistory[did] = new Array(seasonHelper[y].raceOrder.length).fill(0);
                                    seasonHelper[y].pointsHistory[did][raceIdx] += pts;
                                }
                            }

                            if (pos === 1) data.recentResults.push({ race: raceName, year: y, winner: did, team: cid, date: scheduleMap[rid].date });
                        }
                    });

                    // Finalize
                    Object.keys(seasonHelper).forEach(year => {
                        const s = seasonHelper[year];
                        const driverStandings = {};
                        const teamStandings = {};
                        
                        if (data.yearlyStats[year]) {
                            Object.entries(data.yearlyStats[year].driverStats).forEach(([id, stat]) => driverStandings[id] = stat.pts);
                            Object.entries(data.yearlyStats[year].teamStats).forEach(([id, stat]) => teamStandings[id] = stat.pts);
                        }

                        const driverChampId = Object.keys(driverStandings).reduce((a, b) => driverStandings[a] > driverStandings[b] ? a : b, null);
                        const teamChampId = Object.keys(teamStandings).reduce((a, b) => teamStandings[a] > teamStandings[b] ? a : b, null);
                        
                        const top5Drivers = Object.entries(driverStandings).sort((a,b) => b[1] - a[1]).slice(0, 5).map(d => d[0]);
                        const cleanHistory = {};
                        
                        top5Drivers.forEach(did => {
                            const raw = s.pointsHistory[did] || [];
                            const cumulative = [];
                            let sum = 0;
                            for(let i=0; i<s.raceOrder.length; i++) {
                                sum += (raw[i] || 0);
                                cumulative.push(sum);
                            }
                            cleanHistory[did] = cumulative;
                        });

                        data.seasons[year] = {
                            year, races: s.raceCount.size, driverChampId, teamChampId,
                            driverStandings, teamStandings,
                            pointsHistory: cleanHistory, raceOrder: s.raceOrder
                        };
                    });

                    data.retirementCauses = Object.entries(data.retirementCauses).map(([name, value]) => ({ name, value })).sort((a, b) => b.value - a.value);
                    Object.keys(data.yearlyStats).forEach(y => {
                        if (data.yearlyStats[y].retirementCauses) {
                            data.yearlyStats[y].retirementCauses = Object.entries(data.yearlyStats[y].retirementCauses).map(([name, value]) => ({ name, value })).sort((a, b) => b.value - a.value);
                        } else {
                            data.yearlyStats[y].retirementCauses = [];
                        }
                    });

                    data.recentResults.sort((a, b) => new Date(b.date) - new Date(a.date));

                    addLog("Sync Complete.");
                    setTimeout(() => onDataLoaded(data), 1000);

                } catch (err) {
                    setError("Connection Error: " + err);
                    setLoading(false);
                }
            };

            return (
                <div className="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in fade-in zoom-in duration-300">
                    <div className="card p-8 max-w-xl w-full relative overflow-hidden border-t-4 border-t-green-500">
                        <div className="flex justify-between items-start mb-6">
                            <div>
                                <h2 className="text-2xl font-bold text-white mb-1 flex items-center gap-3 font-display tracking-wide">
                                    <div className="p-2 bg-green-500/10 rounded-full">
                                        <Icons.Database className="w-5 h-5 text-green-500" />
                                    </div>
                                    ORACLE TELEMETRY UPLINK
                                </h2>
                                <p className="text-slate-400 text-xs font-mono uppercase tracking-wider ml-1">Secure Gateway // Port: 87a8f04</p>
                            </div>
                            <button onClick={() => onDataLoaded(null)} className="text-slate-500 hover:text-white transition"><Icons.X className="w-6 h-6"/></button>
                        </div>

                        <div className="bg-black/40 p-4 rounded-lg font-mono text-xs text-green-400 h-48 overflow-y-auto border border-slate-800 mb-6 scroll-hide shadow-inner">
                            {logs.length === 0 ? <span className="text-slate-600 animate-pulse">_awaiting_command</span> : logs.map((l, i) => <div key={i} className="mb-1">{l}</div>)}
                        </div>

                        {error && <div className="text-red-400 text-sm p-3 bg-red-900/20 border border-red-900/50 rounded mb-4 flex items-center gap-2"><Icons.Flag className="w-4 h-4"/> {error}</div>}

                        <button onClick={fetchAndProcess} disabled={loading} className={`w-full py-4 rounded-lg font-bold tracking-widest uppercase transition-all transform active:scale-[0.98] flex justify-center items-center gap-3 text-sm ${loading ? 'bg-slate-800 text-slate-500 cursor-not-allowed' : 'bg-green-600 hover:bg-green-500 text-white shadow-lg shadow-green-900/20'}`}>
                            {loading ? <><div className="loading-spinner"></div> ESTABLISHING LINK...</> : "ESTABLISH LINK"}
                        </button>
                    </div>
                </div>
            );
        };

        const StatCard = ({ title, value, Icon, color = "text-white" }) => (
            <div className="card p-6 flex items-center gap-5 group hover:-translate-y-1 transition-all duration-300 bg-gradient-to-br from-slate-900/80 to-slate-900/40">
                <div className={`p-3 rounded-lg bg-slate-800/50 group-hover:scale-110 transition-transform duration-300 border border-slate-700/50 ${color}`}>
                    <Icon className="w-6 h-6" />
                </div>
                <div>
                    <div className="text-slate-400 text-[10px] uppercase tracking-widest font-bold mb-1 opacity-80">{title}</div>
                    <div className="text-2xl font-mono font-bold text-white tracking-tight group-hover:text-white transition-colors">{value}</div>
                </div>
            </div>
        );

        // ... (DriverComparison preserved same as before) ...
        const DriverComparison = ({ data }) => {
            const [d1, setD1] = useState("");
            const [d2, setD2] = useState("");
            const drivers = Object.entries(data.driverStats).sort((a,b) => b[1].wins - a[1].wins).map(([id, s]) => ({ id, name: data.drivers[id]?.name }));
            const getStats = (id) => data.driverStats[id] || { wins: 0, pods: 0, poles: 0, dnfs: 0, pts: 0, races: 1 };
            const s1 = getStats(d1); const s2 = getStats(d2);
            const maxValues = { wins: Math.max(s1.wins, s2.wins, 1), pods: Math.max(s1.pods, s2.pods, 1), poles: Math.max(s1.poles, s2.poles, 1), pts: Math.max(s1.pts, s2.pts, 1), races: Math.max(s1.races, s2.races, 1) };
            const radarData = [ { subject: 'Wins', A: (s1.wins/maxValues.wins)*100, B: (s2.wins/maxValues.wins)*100 }, { subject: 'Podiums', A: (s1.pods/maxValues.pods)*100, B: (s2.pods/maxValues.pods)*100 }, { subject: 'Poles', A: (s1.poles/maxValues.poles)*100, B: (s2.poles/maxValues.poles)*100 }, { subject: 'Points', A: (s1.pts/maxValues.pts)*100, B: (s2.pts/maxValues.pts)*100 }, { subject: 'Exp.', A: (s1.races/maxValues.races)*100, B: (s2.races/maxValues.races)*100 } ];
            return (
                <div className="h-full flex flex-col gap-8 animate-in fade-in zoom-in duration-300">
                    <div className="grid grid-cols-2 gap-6"><div className="relative"><select className="w-full bg-slate-900 text-white p-4 rounded-lg border border-slate-800 appearance-none focus:border-red-500 outline-none font-mono text-sm" onChange={e => setD1(e.target.value)} value={d1}><option value="">Select Driver A</option>{drivers.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}</select></div><div className="relative"><select className="w-full bg-slate-900 text-white p-4 rounded-lg border border-slate-800 appearance-none focus:border-blue-500 outline-none font-mono text-sm" onChange={e => setD2(e.target.value)} value={d2}><option value="">Select Driver B</option>{drivers.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}</select></div></div>
                    {d1 && d2 ? ( <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center"><div className="h-96 card p-6 flex justify-center items-center relative"><ResponsiveContainer width="100%" height="100%"><RadarChart cx="50%" cy="50%" outerRadius="70%" data={radarData}><PolarGrid stroke="#334155" strokeDasharray="3 3" /><PolarAngleAxis dataKey="subject" stroke="#94a3b8" tick={{ fill: '#94a3b8', fontSize: 12, fontWeight: 600, fontFamily: 'Chakra Petch' }} /><PolarRadiusAxis angle={30} domain={[0, 100]} stroke="transparent" /><Radar name={data.drivers[d1]?.name} dataKey="A" stroke="#ef4444" strokeWidth={2} fill="#ef4444" fillOpacity={0.2} /><Radar name={data.drivers[d2]?.name} dataKey="B" stroke="#3b82f6" strokeWidth={2} fill="#3b82f6" fillOpacity={0.2} /><Legend /><Tooltip content={<CustomTooltip />} /></RadarChart></ResponsiveContainer></div><div className="space-y-1 card p-6 h-96 overflow-y-auto bg-slate-900/40"><div className="flex justify-between items-center text-[10px] text-slate-500 uppercase tracking-widest border-b border-slate-800 pb-4 mb-4"><span className="text-red-500 font-bold w-1/3 truncate">{data.drivers[d1]?.name}</span><span className="w-1/3 text-center">VS</span><span className="text-blue-500 font-bold w-1/3 text-right truncate">{data.drivers[d2]?.name}</span></div>{[ { l: 'Wins', k: 'wins' }, { l: 'Podiums', k: 'pods' }, { l: 'Poles', k: 'poles' }, { l: 'DNFs', k: 'dnfs' }, { l: 'Points', k: 'pts', fmt: v => v.toFixed(0) }, { l: 'Races', k: 'races' } ].map(row => ( <div key={row.k} className="flex justify-between items-center py-3 border-b border-slate-800/50 hover:bg-slate-800/30 px-2 rounded transition"><span className={`font-mono text-lg w-1/3 ${s1[row.k] > s2[row.k] ? 'text-red-400 font-bold' : 'text-slate-600'}`}>{row.fmt ? row.fmt(s1[row.k]) : s1[row.k]}</span><span className="text-slate-500 text-[10px] uppercase tracking-wider w-1/3 text-center font-bold">{row.l}</span><span className={`font-mono text-lg w-1/3 text-right ${s2[row.k] > s1[row.k] ? 'text-blue-400 font-bold' : 'text-slate-600'}`}>{row.fmt ? row.fmt(s2[row.k]) : s2[row.k]}</span></div> ))}</div></div> ) : ( <div className="flex flex-col items-center justify-center h-64 text-slate-600 border border-dashed border-slate-800 rounded-xl bg-slate-900/20"><Icons.Swords className="w-12 h-12 mb-4 opacity-20" /><p className="text-xs uppercase tracking-widest font-bold">Select Drivers to Compare</p></div> )}
                </div>
            );
        };

        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                return ( <div className="custom-tooltip"><p className="text-slate-400 text-[10px] mb-1 uppercase tracking-wider font-bold">{label}</p>{payload.map((entry, index) => ( <div key={index} className="text-xs font-bold font-mono" style={{ color: entry.color }}>{entry.name}: {entry.value.toLocaleString()}</div> ))}</div> );
            }
            return null;
        };

        const App = () => {
            const [data, setData] = useState(INITIAL_DATA);
            const [view, setView] = useState("dashboard");
            const [showUploader, setShowUploader] = useState(false);
            const [isDemo, setIsDemo] = useState(true);
            const [searchTerm, setSearchTerm] = useState("");
            const [selectedId, setSelectedId] = useState(null);
            const [selectedYear, setSelectedYear] = useState("All Time");
            
            const [archiveYear, setArchiveYear] = useState("All Time");
            const [archiveType, setArchiveType] = useState("drivers");

            const handleDataLoaded = (newData) => {
                if (newData) { setData(newData); setIsDemo(false); }
                setShowUploader(false);
            };

            const availableYears = useMemo(() => ["All Time", ...Object.keys(data.seasons || {}).sort((a, b) => b - a)], [data.seasons]);

            const currentStats = useMemo(() => {
                if (selectedYear === "All Time" || !data.yearlyStats || !data.yearlyStats[selectedYear]) {
                    return { drivers: data.driverStats, teams: data.teamStats, causes: data.retirementCauses, races: data.recentResults.length };
                }
                return { drivers: data.yearlyStats[selectedYear].driverStats, teams: data.yearlyStats[selectedYear].teamStats, causes: data.yearlyStats[selectedYear].retirementCauses, races: data.seasons[selectedYear]?.races || 0 };
            }, [data, selectedYear]);

            const topDrivers = useMemo(() => Object.entries(currentStats.drivers || {}).filter(([id]) => data.drivers[id]).map(([id, s]) => ({ id, ...s, name: data.drivers[id].name })).sort((a, b) => b.wins - a.wins).slice(0, 10), [currentStats, data.drivers]);
            const topPitTeams = useMemo(() => Object.entries(currentStats.teams || {}).filter(([id]) => data.teams[id] && currentStats.teams[id].pitCount > (selectedYear === "All Time" ? 5 : 1)).map(([id, s]) => ({ id, ...s, name: data.teams[id].name })).sort((a, b) => a.pitAvg - b.pitAvg).slice(0, 10), [currentStats, data.teams, selectedYear]);

            const renderDashboard = () => (
                <div className="space-y-8 animate-in fade-in duration-500">
                    <div className="flex justify-between items-center">
                        <h2 className="text-lg font-bold text-white uppercase tracking-widest font-display">System Overview</h2>
                        <select value={selectedYear} onChange={(e) => setSelectedYear(e.target.value)} className="bg-slate-900 text-white px-4 py-2 rounded border border-slate-700 text-xs font-mono focus:border-red-500 outline-none uppercase font-bold tracking-wider">
                            {availableYears.map(y => <option key={y} value={y}>{y}</option>)}
                        </select>
                    </div>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <StatCard title="Total Races" value={selectedYear === "All Time" ? (isDemo ? "1,100+" : data.recentResults.length) : currentStats.races} Icon={Icons.Flag} color="text-red-500" />
                        <StatCard title="Active Drivers" value={Object.keys(currentStats.drivers).length} Icon={Icons.Users} color="text-blue-500" />
                        <StatCard title="Seasons" value={selectedYear === "All Time" ? Object.keys(data.seasons || {}).length : 1} Icon={Icons.Calendar} color="text-purple-500" />
                        <StatCard title="Win Leader" value={`${topDrivers[0]?.name.split(' ').pop() || 'N/A'} (${topDrivers[0]?.wins || 0})`} Icon={Icons.Trophy} color="text-yellow-500" />
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="card p-6"><div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-4"><h3 className="text-sm font-bold text-white tracking-widest uppercase font-display flex items-center gap-2"><span className="w-1.5 h-4 bg-red-600 rounded-sm"></span>Victory Leaders</h3><span className="text-[10px] text-slate-500 font-mono uppercase tracking-wider">{selectedYear} Wins</span></div><div className="h-80"><ResponsiveContainer width="100%" height="100%"><BarChart data={topDrivers} layout="vertical" margin={{ left: 20 }}><defs><linearGradient id="gradWins" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stopColor="#ef4444" stopOpacity={0.8}/><stop offset="100%" stopColor="#ef4444" stopOpacity={0.2}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3" stroke="#1e293b" horizontal={false} /><XAxis type="number" hide /><YAxis dataKey="name" type="category" width={130} style={{fontSize:'11px', fontWeight:'600', fill:'#94a3b8', fontFamily:'Chakra Petch'}} /><Tooltip content={<CustomTooltip />} /><Bar dataKey="wins" fill="url(#gradWins)" radius={[0, 4, 4, 0]} barSize={20} /></BarChart></ResponsiveContainer></div></div>
                        <div className="card p-6"><div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-4"><h3 className="text-sm font-bold text-white tracking-widest uppercase font-display flex items-center gap-2"><span className="w-1.5 h-4 bg-green-500 rounded-sm"></span>Pit Crew Elite</h3><span className="text-[10px] text-green-500 font-mono uppercase tracking-wider">Avg Stop (s)</span></div>{topPitTeams.length > 0 ? (<div className="h-80"><ResponsiveContainer width="100%" height="100%"><BarChart data={topPitTeams} layout="vertical" margin={{ left: 20 }}><defs><linearGradient id="gradPit" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stopColor="#10b981" stopOpacity={0.8}/><stop offset="100%" stopColor="#10b981" stopOpacity={0.2}/></linearGradient></defs><XAxis type="number" domain={[0, 'auto']} hide /><YAxis dataKey="name" type="category" width={130} style={{fontSize:'11px', fontWeight:'600', fill:'#94a3b8', fontFamily:'Chakra Petch'}} /><Tooltip content={<CustomTooltip />} /><Bar dataKey="pitAvg" fill="url(#gradPit)" radius={[0, 4, 4, 0]} barSize={20} /></BarChart></ResponsiveContainer></div>) : <div className="h-80 flex items-center justify-center text-slate-600 text-xs uppercase tracking-widest font-bold border border-dashed border-slate-800 rounded bg-slate-900/20">Insufficient Data</div>}</div>
                    </div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                        <div className="card p-6 lg:col-span-1"><div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-4"><h3 className="text-sm font-bold text-white tracking-widest uppercase font-display">Attrition</h3><span className="text-[10px] text-slate-500 font-mono uppercase tracking-wider">DNF Causes</span></div><div className="h-64"><ResponsiveContainer><PieChart><Pie data={currentStats.causes} cx="50%" cy="50%" innerRadius={50} outerRadius={80} paddingAngle={4} dataKey="value" stroke="none">{currentStats.causes.map((e,i) => <Cell key={i} fill={PIE_COLORS[i%PIE_COLORS.length]} />)}</Pie><Tooltip content={<CustomTooltip />} /><Legend verticalAlign="bottom" iconType="circle" wrapperStyle={{fontSize:'10px', fontFamily:'Inter'}} /></PieChart></ResponsiveContainer></div></div>
                        <div className="card p-6 lg:col-span-2"><div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-4"><h3 className="text-sm font-bold text-white tracking-widest uppercase font-display">Race Log</h3><span className="text-[10px] text-slate-500 font-mono uppercase tracking-wider">Recent GPs</span></div><div className="overflow-x-auto"><table className="w-full text-left text-sm text-slate-400"><thead className="bg-slate-900/50 text-slate-500 uppercase font-bold text-[10px] tracking-widest"><tr><th className="px-6 py-4 rounded-l-lg">Year</th><th className="px-6 py-4">Grand Prix</th><th className="px-6 py-4">Winner</th><th className="px-6 py-4 rounded-r-lg">Team</th></tr></thead><tbody className="divide-y divide-slate-800/50">{data.recentResults.filter(r => selectedYear === "All Time" || r.year.toString() === selectedYear).slice(0, 6).map((r, i) => (<tr key={i} className="hover:bg-white/5 transition duration-150"><td className="px-6 py-4 font-mono text-xs text-slate-500">{r.year}</td><td className="px-6 py-4 text-white font-bold text-xs uppercase tracking-wide">{r.race}</td><td className="px-6 py-4 text-slate-300 flex items-center gap-2 text-xs font-mono"><span className="w-1 h-1 bg-red-500 rounded-full"></span>{data.drivers[r.winner]?.name}</td><td className="px-6 py-4 text-slate-500 text-xs uppercase font-bold tracking-wider">{data.teams[r.team]?.name}</td></tr>))}</tbody></table></div></div>
                    </div>
                </div>
            );

            const renderArchive = () => {
                const targetStats = (archiveYear === "All Time" || !data.yearlyStats[archiveYear]) ? (archiveType === 'drivers' ? data.driverStats : data.teamStats) : (archiveType === 'drivers' ? data.yearlyStats[archiveYear].driverStats : data.yearlyStats[archiveYear].teamStats);
                const source = archiveType === 'drivers' ? data.drivers : data.teams;
                const list = Object.entries(source).map(([id, obj]) => ({ id, name: obj.name, sub: obj.nat, stats: targetStats[id] || { wins: 0, pods: 0, pts: 0, races: 0, scored: 0, dnfs: 0 } })).filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase()) && (archiveYear === "All Time" || item.stats.races > 0)).sort((a, b) => b.stats.pts - a.stats.pts).map(item => ({ id: item.id, name: item.name, sub: item.sub, rightMain: `${(item.stats.pts || 0).toLocaleString()}`, rightSub: `PTS`, data: item }));

                return (
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 h-[calc(100vh-140px)] animate-in slide-in-from-bottom-4 duration-500">
                        <div className="card flex flex-col h-full overflow-hidden border-slate-800">
                            <div className="p-6 border-b border-slate-800 bg-slate-900/30 space-y-4">
                                <div className="flex gap-2"><select value={archiveYear} onChange={(e) => setArchiveYear(e.target.value)} className="w-1/2 bg-slate-900 border border-slate-700 rounded-lg p-3 text-white text-xs font-bold uppercase focus:border-green-500 outline-none tracking-wider font-mono">{availableYears.map(y => <option key={y} value={y}>{y}</option>)}</select><select value={archiveType} onChange={(e) => {setArchiveType(e.target.value); setSelectedId(null);}} className="w-1/2 bg-slate-900 border border-slate-700 rounded-lg p-3 text-white text-xs font-bold uppercase focus:border-green-500 outline-none tracking-wider font-mono"><option value="drivers">Drivers</option><option value="teams">Constructors</option></select></div>
                                <input type="text" placeholder="SEARCH ARCHIVES..." className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-green-500 outline-none transition font-mono text-xs uppercase font-bold tracking-wider" onChange={e => setSearchTerm(e.target.value)} />
                            </div>
                            <div className="flex-1 overflow-y-auto p-4 space-y-2 scroll-hide">
                                {list.map(item => ( <div key={item.id} onClick={() => setSelectedId(item.id)} className={`p-4 rounded-lg cursor-pointer flex justify-between items-center transition-all duration-200 border ${selectedId === item.id ? 'bg-green-500/10 border-green-500/50' : 'bg-slate-900/40 border-transparent hover:bg-slate-800 hover:border-slate-700'}`}><div><div className="text-white font-bold text-xs uppercase tracking-wide font-display">{item.name}</div><div className="text-[10px] text-slate-500 uppercase mt-1 tracking-wider font-bold">{item.sub}</div></div><div className="text-right"><div className="text-lg font-mono font-bold text-white">{item.rightMain}</div><div className="text-[9px] text-slate-600 uppercase tracking-widest font-bold">{item.rightSub}</div></div></div> ))}
                            </div>
                        </div>
                        <div className="lg:col-span-2 card p-8 flex flex-col justify-center items-center h-full relative overflow-hidden bg-gradient-to-br from-slate-900/80 to-slate-950">
                            {selectedId ? ( (() => { const item = list.find(i => i.id === selectedId); if (!item) return null; const stats = item.data.stats; const races = stats.races || 1; const winPct = ((stats.wins/races)*100).toFixed(1); const pieData = [{ name: 'Wins', value: stats.wins }, { name: 'Podiums', value: stats.pods - stats.wins }, { name: 'Points', value: stats.scored - stats.pods }, { name: 'No Pts', value: races - stats.scored - stats.dnfs }, { name: 'DNF', value: stats.dnfs }].filter(x => x.value > 0); return ( <div className="w-full h-full overflow-y-auto scroll-hide space-y-8 animate-in zoom-in duration-300"><div className="text-center border-b border-slate-800 pb-8"><div className="text-[10px] text-green-500 font-mono mb-3 uppercase tracking-[0.2em] font-bold">{archiveYear} Statistics</div><div className="text-5xl font-bold text-white mb-2 tracking-tighter font-display uppercase">{item.name}</div><div className="text-sm text-slate-500 font-bold uppercase tracking-[0.3em]">{item.sub}</div></div><div className="grid grid-cols-2 md:grid-cols-4 gap-4">{[ { l: 'Wins', v: stats.wins, sub: `${winPct}%`, c:'text-red-500' }, { l: 'Podiums', v: stats.pods, sub: 'Top 3', c:'text-blue-400' }, { l: 'Poles', v: stats.poles, sub: 'P1 Starts', c:'text-purple-400' }, { l: 'Total Pts', v: (stats.pts||0).toLocaleString(), sub: 'Season', c:'text-yellow-400' } ].map((s, i) => ( <div key={i} className="bg-slate-900/60 p-4 rounded-lg border border-slate-800 text-center hover:border-slate-700 transition"><div className="text-[9px] text-slate-500 uppercase tracking-widest font-bold mb-1">{s.l}</div><div className={`text-2xl font-mono font-bold ${s.c}`}>{s.v}</div><div className="text-[9px] text-slate-600 mt-1 font-bold">{s.sub}</div></div> ))}</div><div className="grid grid-cols-1 md:grid-cols-2 gap-6"><div className="bg-slate-900/60 p-6 rounded-xl border border-slate-800 h-64"><h4 className="text-[10px] text-slate-500 uppercase tracking-widest font-bold mb-4">Distribution</h4><ResponsiveContainer width="100%" height="100%"><PieChart><Pie data={pieData} cx="50%" cy="50%" innerRadius={40} outerRadius={60} paddingAngle={5} dataKey="value" stroke="none">{pieData.map((entry, index) => <Cell key={`cell-${index}`} fill={PIE_COLORS[index % PIE_COLORS.length]} />)}</Pie><Tooltip content={<CustomTooltip />} /><Legend verticalAlign="middle" layout="vertical" align="right" iconType="circle" wrapperStyle={{fontSize:'10px', fontFamily:'Inter'}}/></PieChart></ResponsiveContainer></div><div className="bg-slate-900/60 p-6 rounded-xl border border-slate-800 h-64 flex flex-col justify-center space-y-5"><h4 className="text-[10px] text-slate-500 uppercase tracking-widest font-bold">Efficiency</h4><div className="space-y-5"><div><div className="flex justify-between text-[10px] text-slate-400 font-bold uppercase mb-1"><span>Scoring Rate</span><span className="font-mono text-blue-400">{((stats.scored/races)*100).toFixed(1)}%</span></div><div className="w-full bg-slate-800 rounded-full h-1.5"><div className="bg-blue-500 h-1.5 rounded-full shadow-[0_0_10px_rgba(59,130,246,0.5)]" style={{width: `${(stats.scored/races)*100}%`}}></div></div></div><div><div className="flex justify-between text-[10px] text-slate-400 font-bold uppercase mb-1"><span>Finish Rate</span><span className="font-mono text-green-400">{(((races-stats.dnfs)/races)*100).toFixed(1)}%</span></div><div className="w-full bg-slate-800 rounded-full h-1.5"><div className="bg-green-500 h-1.5 rounded-full shadow-[0_0_10px_rgba(34,197,94,0.5)]" style={{width: `${((races-stats.dnfs)/races)*100}%`}}></div></div></div><div><div className="flex justify-between text-[10px] text-slate-400 font-bold uppercase mb-1"><span>Win Rate</span><span className="font-mono text-red-500">{winPct}%</span></div><div className="w-full bg-slate-800 rounded-full h-1.5"><div className="bg-red-600 h-1.5 rounded-full shadow-[0_0_10px_rgba(220,38,38,0.5)]" style={{width: `${Math.min(parseFloat(winPct), 100)}%`}}></div></div></div></div></div></div></div> ); })() ) : <div className="text-center opacity-30"><Icons.MousePointer2 className="w-20 h-20 mx-auto mb-4 opacity-50" /><p className="text-lg font-mono uppercase tracking-widest">Select Entity to Inspect</p></div>}
                        </div>
                    </div>
                );
            };

            const renderSeasons = () => {
                const list = Object.values(data.seasons).sort((a, b) => b.year - a.year).map(s => ({ id: s.year.toString(), name: s.year.toString(), sub: `${s.races} Rounds`, rightMain: data.drivers[s.driverChampId]?.name || "Unknown", rightSub: "Champion", data: s }));
                return (
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 h-[calc(100vh-140px)] animate-in slide-in-from-bottom-4 duration-500">
                        <div className="card flex flex-col h-full overflow-hidden border-slate-800"><div className="p-6 border-b border-slate-800 bg-slate-900/30"><input type="text" placeholder="SEARCH SEASON..." className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-red-500 outline-none transition font-mono text-xs font-bold uppercase tracking-wider" onChange={e => setSearchTerm(e.target.value)} /></div><div className="flex-1 overflow-y-auto p-4 space-y-2 scroll-hide">{list.map(item => ( <div key={item.id} onClick={() => setSelectedId(item.id)} className={`p-4 rounded-lg cursor-pointer flex justify-between items-center transition-all duration-200 border ${selectedId === item.id ? 'bg-red-600/10 border-red-500/50' : 'bg-slate-900/40 border-transparent hover:bg-slate-800 hover:border-slate-700'}`}><div><div className="text-white font-bold text-sm font-mono">{item.name}</div><div className="text-[10px] text-slate-500 uppercase mt-1 font-bold tracking-wider">{item.sub}</div></div><div className="text-right"><div className="text-sm font-bold text-white truncate w-32 text-right uppercase">{item.rightMain}</div><div className="text-[9px] text-slate-600 uppercase tracking-widest font-bold">{item.rightSub}</div></div></div> ))}</div></div>
                        <div className="lg:col-span-2 card p-8 flex flex-col justify-center items-center h-full relative overflow-hidden bg-gradient-to-br from-slate-900/80 to-slate-950">
                            {selectedId ? ( (() => { const item = list.find(i => i.id === selectedId); if (!item) return null; const s = item.data; const topDrivers = Object.entries(s.driverStandings).sort((a,b) => b[1] - a[1]).slice(0, 5).map(([id, pts]) => ({ id, name: data.drivers[id]?.name, pts })); const chartData = s.raceOrder.map((raceName, idx) => { const point = { name: raceName }; topDrivers.forEach(d => { if (s.pointsHistory && s.pointsHistory[d.id]) point[d.name] = s.pointsHistory[d.id][idx]; }); return point; }); return ( <div className="w-full h-full overflow-y-auto scroll-hide space-y-8 animate-in fade-in"><div className="text-center"><div className="text-8xl font-black text-white mb-2 tracking-tighter opacity-90 font-display">{s.year}</div><div className="inline-block px-4 py-1 rounded-full bg-slate-900/80 text-[10px] font-mono text-slate-400 border border-slate-700 uppercase tracking-[0.2em] font-bold">{s.races} Rounds Completed</div></div>{s.pointsHistory && ( <div className="bg-slate-900/60 p-6 rounded-xl border border-slate-800"><h4 className="text-slate-400 font-bold mb-6 text-[10px] uppercase tracking-[0.2em] flex items-center gap-2"><span className="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></span> Title Fight</h4><div className="h-72"><ResponsiveContainer width="100%" height="100%"><LineChart data={chartData}><CartesianGrid strokeDasharray="3 3" stroke="#1e293b" /><XAxis dataKey="name" stroke="#64748b" style={{fontSize:'9px', fontFamily:'Inter', fontWeight:'600'}} /><YAxis stroke="#64748b" width={30} style={{fontSize:'10px', fontFamily:'Chakra Petch'}} /><Tooltip content={<CustomTooltip />} /><Legend wrapperStyle={{fontSize:'10px', fontFamily:'Inter', textTransform:'uppercase', fontWeight:'bold'}} />{topDrivers.map((d, i) => <Line key={d.id} type="monotone" dataKey={d.name} stroke={COLORS[i % COLORS.length]} dot={false} strokeWidth={3} />)}</LineChart></ResponsiveContainer></div></div> )}<div className="grid grid-cols-2 gap-6"><div className="bg-slate-900/40 p-6 rounded-xl border border-slate-800 text-center hover:border-red-900/30 transition"><div className="text-slate-500 text-[9px] uppercase tracking-[0.2em] font-bold mb-2">Driver Champion</div><div className="text-xl font-bold text-white uppercase font-display">{data.drivers[s.driverChampId]?.name || "N/A"}</div></div><div className="bg-slate-900/40 p-6 rounded-xl border border-slate-800 text-center hover:border-blue-900/30 transition"><div className="text-slate-500 text-[9px] uppercase tracking-[0.2em] font-bold mb-2">Constructor Champion</div><div className="text-xl font-bold text-white uppercase font-display">{data.teams[s.teamChampId]?.name || "N/A"}</div></div></div></div> ); })() ) : <div className="text-center opacity-30"><Icons.MousePointer2 className="w-20 h-20 mx-auto mb-4 opacity-50" /><p className="text-lg font-mono uppercase tracking-widest">Select Season</p></div>}
                        </div>
                    </div>
                );
            }

            return (
                <div className="min-h-screen pb-10 pt-24">
                    {showUploader && <DataFetcher onDataLoaded={handleDataLoaded} />}

                    <header className="fixed top-0 left-0 right-0 z-40 bg-[#09090b]/80 backdrop-blur-md border-b border-white/5">
                        <div className="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
                            <div className="flex items-center gap-4">
                                <div className="w-10 h-10 bg-gradient-to-br from-red-600 to-red-900 rounded-xl flex items-center justify-center font-black italic text-white text-xl shadow-[0_0_20px_rgba(220,38,38,0.4)] transform -skew-x-12 border border-red-500/30">F1</div>
                                <div><h1 className="font-bold text-lg tracking-tight leading-none text-white font-display">TELEMETRY <span className="text-red-500">HUB</span></h1><span className="text-[10px] text-slate-500 uppercase tracking-[0.3em] font-bold">Official Analytics</span></div>
                            </div>
                            <nav className="hidden md:flex bg-slate-900/50 p-1 rounded-lg border border-white/5">
                                {['dashboard', 'compare', 'archives', 'seasons'].map(tab => (
                                    <button key={tab} onClick={() => { setView(tab); setSelectedId(null); }} className={`px-6 py-2 rounded-md text-[10px] font-bold transition-all duration-300 uppercase tracking-[0.15em] ${view === tab ? 'bg-red-600 text-white shadow-lg' : 'text-slate-400 hover:text-white hover:bg-white/5'}`}>{tab}</button>
                                ))}
                            </nav>
                            <div className="flex items-center gap-4">
                                {isDemo && <span className="hidden lg:flex px-3 py-1 rounded border border-yellow-500/20 bg-yellow-500/10 text-yellow-500 text-[10px] font-bold uppercase tracking-wider items-center gap-2 font-mono"><span className="w-1.5 h-1.5 bg-yellow-500 rounded-full animate-pulse"></span> Demo Mode</span>}
                                <button onClick={() => setShowUploader(true)} className="group flex items-center gap-2 bg-white text-black px-5 py-2 rounded-md text-[10px] font-bold uppercase tracking-widest transition hover:bg-slate-200 hover:shadow-[0_0_20px_rgba(255,255,255,0.2)]"><Icons.Database className="w-3 h-3 group-hover:scale-110 transition-transform" /><span>Database Link</span></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-6 py-8 animate-in fade-in slide-in-from-bottom-8 duration-700">
                        {view === 'dashboard' && renderDashboard()}
                        {view === 'compare' && <DriverComparison data={data} />}
                        {view === 'archives' && renderArchive()}
                        {view === 'seasons' && renderSeasons()}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
