<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Telemetry Dashboard v3.0</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Prop Types (Required by Recharts) -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>

    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Recharts for Charts (Pinned Version) -->
    <script src="https://unpkg.com/recharts@2.10.3/umd/Recharts.js"></script>
    
    <!-- PapaParse for CSV Processing -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- Markdown Parser for AI Responses -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@300;400;500;600;700&family=Inter:wght@300;400;500;600;700&display=swap');

        body { 
            background-color: #09090b; 
            color: #e2e8f0; 
            font-family: 'Inter', sans-serif; 
            background-image: 
                radial-gradient(at 0% 0%, rgba(220, 38, 38, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(37, 99, 235, 0.15) 0px, transparent 50%);
            background-attachment: fixed;
        }
        
        h1, h2, h3, h4, h5, h6, .font-display { font-family: 'Chakra Petch', sans-serif; }
        .font-mono { font-family: 'Chakra Petch', monospace; }
        
        /* Modern Card */
        .card { 
            background-color: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08); 
            border-radius: 0.75rem; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .card:hover {
            border-color: rgba(255, 255, 255, 0.2);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            transform: translateY(-2px);
        }

        .scroll-hide::-webkit-scrollbar { width: 6px; height: 6px; }
        .scroll-hide::-webkit-scrollbar-track { background: transparent; }
        .scroll-hide::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        .scroll-hide::-webkit-scrollbar-thumb:hover { background: #475569; }
        
        .f1-red-text { color: #ef4444; }
        
        .loading-spinner { 
            border: 2px solid rgba(255,255,255,0.1); 
            border-left-color: #ef4444; 
            border-radius: 50%; 
            width: 20px; 
            height: 20px; 
            animation: spin 0.8s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Custom Recharts Tooltip */
        .custom-tooltip {
            background: rgba(15, 23, 42, 0.95);
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 8px 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
            font-family: 'Inter', sans-serif;
            font-size: 0.85rem;
        }
        
        .nav-item.active { color: #fff; border-bottom: 2px solid #ef4444; }
        .nav-item { color: #94a3b8; border-bottom: 2px solid transparent; }
        .nav-item:hover { color: #cbd5e1; }

        /* Markdown Styles for AI Chat */
        .ai-response p { margin-bottom: 0.5rem; }
        .ai-response strong { color: #ef4444; font-weight: 600; }
        .ai-response ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 0.5rem; }
        .ai-response li { margin-bottom: 0.25rem; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        
        const { 
            BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, 
            LineChart, Line, PieChart, Pie, Cell, Radar, RadarChart, PolarGrid, PolarAngleAxis, PolarRadiusAxis,
            Area, AreaChart
        } = window.Recharts || {};

        // --- CONSTANTS & ICONS ---
        const Icons = {
            Flag: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/><line x1="4" x2="4" y1="22" y2="15"/></svg>,
            Users: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            Wrench: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M14.7 6.3a1 1 0 0 0 0 1.4l1.6 1.6a1 1 0 0 0 1.4 0l3.77-3.77a6 6 0 0 1-7.94 7.94l-6.91 6.91a2.12 2.12 0 0 1-3-3l6.91-6.91a6 6 0 0 1 7.94-7.94l-3.76 3.76z"/></svg>,
            Trophy: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
            Database: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"/><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"/></svg>,
            MousePointer2: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M3 3l7.07 16.97 2.51-7.39 7.39-2.51L3 3z"/><path d="M13 13l6 6"/></svg>,
            Calendar: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
            Swords: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polyline points="14.5 17.5 3 6 3 3 6 3 17.5 14.5"/><line x1="13" x2="19" y1="19" y2="13"/><line x1="16" x2="20" y1="16" y2="20"/><line x1="19" x2="21" y1="21" y2="19"/></svg>,
            Activity: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>,
            X: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>,
            Archive: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><rect width="20" height="5" x="2" y="4" rx="2"/><path d="M4 9v9a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9"/><path d="M10 13h4"/></svg>,
            Map: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><polygon points="3 6 9 3 15 6 21 3 21 18 15 21 9 18 3 21"/><line x1="9" x2="9" y1="3" y2="18"/><line x1="15" x2="15" y1="6" y2="21"/></svg>,
            Brain: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M9.5 2A2.5 2.5 0 0 1 12 4.5v15a2.5 2.5 0 0 1-4.96.44 2.5 2.5 0 0 1-2.96-3.08 3 3 0 0 1-.34-5.58 2.5 2.5 0 0 1 1.32-4.24 2.5 2.5 0 0 1 1.98-3A2.5 2.5 0 0 1 9.5 2Z"/><path d="M14.5 2A2.5 2.5 0 0 0 12 4.5v15a2.5 2.5 0 0 0 4.96.44 2.5 2.5 0 0 0 2.96-3.08 3 3 0 0 0 .34-5.58 2.5 2.5 0 0 0-1.32-4.24 2.5 2.5 0 0 0-1.98-3A2.5 2.5 0 0 0 14.5 2Z"/></svg>,
            Sparkles: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m12 3-1.912 5.813a2 2 0 0 1-1.275 1.275L3 12l5.813 1.912a2 2 0 0 1 1.275 1.275L12 21l1.912-5.813a2 2 0 0 1 1.275-1.275L21 12l-5.813-1.912a2 2 0 0 1-1.275-1.275L12 3Z"/><path d="M5 3v4"/><path d="M9 3v4"/><path d="M3 5h4"/><path d="M3 9h4"/></svg>,
            Settings: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Send: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            PieChart: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>,
            AlertTriangle: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><line x1="12" x2="12" y1="9" y2="13"/><line x1="12" x2="12.01" y1="17" y2="17"/></svg>,
            Clock: (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" {...props}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        };

        const INITIAL_DATA = {
            drivers: { "830": { name: "Max Verstappen", nat: "Dutch" }, "815": { name: "Sergio Perez", nat: "Mexican" } },
            teams: { "9": { name: "Red Bull", nat: "Austrian" }, "131": { name: "Mercedes", nat: "German" } },
            driverStats: { "830": { wins: 19, pods: 21, races: 22, pts: 575, poles: 12, dnfs: 0, scored: 22 } },
            teamStats: { "9": { wins: 21, pods: 30, races: 44, pts: 860, poles: 14, dnfs: 2, scored: 42 } },
            seasons: { "2023": { year: 2023, races: 22, driverChampId: "830", teamChampId: "9", driverStandings: { "830": 575 }, teamStandings: { "9": 860 }, raceOrder: ["Bahrain"], pointsHistory: { "830": [25] } } },
            recentResults: [ { race: "Abu Dhabi GP", year: 2023, winner: "830", team: "9" } ],
            retirementCauses: [ { name: "Accident", value: 45 } ],
            yearlyStats: {},
            circuits: { "silverstone": { name: "Silverstone Circuit", country: "UK", races: 58, winners: {"1":8}, poles: {"1":7}, safetyCars: 12 } },
            pitStops: [] 
        };

        const COLORS = ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6', '#a855f7'];
        const PIE_COLORS = ['#ef4444', '#334155', '#475569', '#64748b', '#94a3b8'];

        // --- GEMINI SERVICE ---
        const _k = "QUl6YVN5QlVwQkVpSE1xdmZjNVBDRm4zYXFUd2ZCWmc4ZDlRVGhJ"; 
        const getDecodedKey = () => { try { return atob(_k); } catch(e) { return ""; } };

        const callGemini = async (userKey, prompt) => {
            const keyToUse = userKey || getDecodedKey(); 
            if (!keyToUse) throw new Error("API Key Required. Please check settings.");
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keyToUse}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            if (!response.ok) throw new Error("Gemini API Error: " + response.statusText);
            const json = await response.json();
            return json.candidates?.[0]?.content?.parts?.[0]?.text || "No analysis generated.";
        };

        // --- COMPONENTS ---
        const SettingsModal = ({ isOpen, onClose, onSave, currentKey }) => {
            const [key, setKey] = useState(currentKey);
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in fade-in">
                    <div className="card p-6 w-full max-w-md border-slate-700">
                        <h3 className="text-lg font-bold text-white mb-4 flex items-center gap-2"><Icons.Settings className="w-5 h-5 text-slate-400"/> System Settings</h3>
                        <div className="space-y-4">
                            <div><label className="block text-xs text-slate-400 mb-2 uppercase tracking-wider font-bold">Gemini API Key</label><input type="password" value={key} onChange={(e) => setKey(e.target.value)} placeholder="Use default or override" className="w-full bg-slate-900 border border-slate-700 rounded p-3 text-white text-sm focus:border-blue-500 outline-none font-mono"/><p className="text-[10px] text-green-500 mt-2">System Key Active. Override if needed.</p></div>
                            <div className="flex justify-end gap-3 mt-6"><button onClick={onClose} className="px-4 py-2 text-sm text-slate-400 hover:text-white">Cancel</button><button onClick={() => onSave(key)} className="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded text-sm font-bold">Save Configuration</button></div>
                        </div>
                    </div>
                </div>
            );
        };

        const AIChat = ({ userKey, data }) => {
            const [messages, setMessages] = useState([{ role: 'system', text: "I am Oracle Strategy AI. Ready for queries." }]);
            const [input, setInput] = useState("");
            const [loading, setLoading] = useState(false);
            const scrollRef = useRef(null);

            useEffect(() => { if (scrollRef.current) scrollRef.current.scrollTop = scrollRef.current.scrollHeight; }, [messages]);

            const handleSend = async () => {
                if (!input.trim()) return;
                const userMsg = input; setInput("");
                setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
                setLoading(true);
                try {
                    const context = `Total Races: ${data.recentResults.length}. Recent Race: ${data.recentResults[0]?.race} (${data.recentResults[0]?.year}).`;
                    const response = await callGemini(userKey, `Context: ${context}. Question: ${userMsg}.`);
                    setMessages(prev => [...prev, { role: 'ai', text: response }]);
                } catch (err) { setMessages(prev => [...prev, { role: 'error', text: err.message }]); } finally { setLoading(false); }
            };

            return (
                <div className="h-[calc(100vh-180px)] grid grid-cols-1 lg:grid-cols-4 gap-6 animate-in fade-in">
                    <div className="lg:col-span-3 card flex flex-col overflow-hidden border-slate-800">
                        <div className="p-4 border-b border-slate-800 bg-slate-900/50 flex justify-between items-center"><div className="flex items-center gap-3"><div className="p-2 bg-blue-500/10 rounded-full"><Icons.Brain className="w-5 h-5 text-blue-500" /></div><div><h3 className="font-bold text-white font-display">Oracle Strategy Channel</h3><div className="flex items-center gap-2"><span className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span><span className="text-[10px] text-slate-400 uppercase tracking-wider">Online</span></div></div></div></div>
                        <div className="flex-1 overflow-y-auto p-6 space-y-6 bg-slate-950/30" ref={scrollRef}>{messages.map((m, i) => (<div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}><div className={`max-w-[80%] p-4 rounded-xl text-sm ${m.role === 'user' ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-slate-800 text-slate-200 rounded-tl-none border border-slate-700'}`}>{m.role === 'ai' ? <div dangerouslySetInnerHTML={{ __html: marked.parse(m.text) }}></div> : m.text}</div></div>))}</div>
                        <div className="p-4 bg-slate-900/50 border-t border-slate-800 flex gap-3"><input type="text" value={input} onChange={(e) => setInput(e.target.value)} onKeyPress={(e) => e.key === 'Enter' && handleSend()} placeholder="Ask strategy..." className="flex-1 bg-[#0b0e14] border border-slate-700 rounded-lg px-4 py-3 text-white focus:border-blue-500 outline-none font-mono text-sm" /><button onClick={handleSend} disabled={loading} className="px-4 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition disabled:opacity-50"><Icons.Send className="w-5 h-5" /></button></div>
                    </div>
                </div>
            );
        };

        const DataFetcher = ({ onDataLoaded }) => {
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState("");
            const [logs, setLogs] = useState([]);
            const BASE_URL = "https://raw.githubusercontent.com/s-harish44/F1/87a8f047ff158f87696fd2e4c2a47da43dd256c9/Datasets/";
            const filesToFetch = ["Driver_Details.csv", "Team_Details.csv", "Race_Results.csv", "Race_Schedule.csv", "Qualifying_Results.csv", "Race_Status.csv", "Sprint_Race_Results.csv", "Pit_Stop_Records.csv", "Track_Information.csv"];
            const addLog = (msg) => setLogs(prev => [...prev, `> ${msg}`]);

            const fetchAndProcess = async () => {
                setLoading(true); setError(""); setLogs(["> Initializing secure connection..."]); 
                const fetchedData = {};
                try {
                    await Promise.all(filesToFetch.map(f => new Promise((resolve, reject) => Papa.parse(BASE_URL + f, { download: true, header: true, skipEmptyLines: true, complete: res => { fetchedData[f] = res.data; addLog(`Latched: ${f} [${res.data.length} rows]`); resolve(); }, error: err => reject(err) }))));
                    addLog("Compiling analytics...");
                    
                    const data = { drivers: {}, teams: {}, driverStats: {}, teamStats: {}, yearlyStats: {}, recentResults: [], seasons: {}, retirementCauses: {}, circuits: {}, pitStops: [] };
                    const scheduleMap = {}, seasonHelper = {};

                    // Basic Info
                    (fetchedData["Driver_Details.csv"] || []).forEach(r => { if(r.driverId) data.drivers[r.driverId] = { name: `${r.forename} ${r.surname}`, nat: r.nationality }; });
                    (fetchedData["Team_Details.csv"] || []).forEach(r => { if(r.constructorId) data.teams[r.constructorId] = { name: r.name, nat: r.nationality }; });
                    (fetchedData["Track_Information.csv"] || []).forEach(t => { if(t.circuitId) data.circuits[t.circuitId] = { name: t.name, country: t.country, location: t.location, races: 0, winners: {}, poles: {}, recentWinners: [] }; });
                    
                    (fetchedData["Race_Schedule.csv"] || []).sort((a,b) => new Date(a.date)-new Date(b.date)).forEach(r => {
                        if(!r.raceId) return;
                        const y = parseInt(r.year); scheduleMap[r.raceId] = { year: y, name: r.name, date: r.date, circuitId: r.circuitId };
                        if(!seasonHelper[y]) seasonHelper[y] = { raceOrder: [], pointsHistory: {}, raceCount: new Set() };
                        if(!seasonHelper[y].raceOrder.includes(r.name)) seasonHelper[y].raceOrder.push(r.name);
                        if(data.circuits[r.circuitId]) data.circuits[r.circuitId].races++;
                    });

                    // Helpers
                    const initStats = () => ({ wins: 0, pods: 0, races: 0, pts: 0, poles: 0, dnfs: 0, scored: 0, pitAvg: 0, pitCount: 0, reliability: { mechanical: 0, accident: 0 } });
                    const getStat = (t, id) => { if(!t[id]) t[id] = initStats(); return t[id]; };
                    const getYearStat = (y, type, id) => { if(!data.yearlyStats[y]) data.yearlyStats[y] = { driverStats: {}, teamStats: {}, retirementCauses: {} }; return getStat(type==='driver'?data.yearlyStats[y].driverStats:data.yearlyStats[y].teamStats, id); };

                    // Quali
                    (fetchedData["Qualifying_Results.csv"] || []).forEach(q => {
                        if(parseInt(q.position)===1 && q.driverId) {
                            getStat(data.driverStats, q.driverId).poles++; 
                            if(q.constructorId) getStat(data.teamStats, q.constructorId).poles++;
                            if(scheduleMap[q.raceId]) {
                                const y = scheduleMap[q.raceId].year;
                                getYearStat(y, 'driver', q.driverId).poles++;
                                getYearStat(y, 'team', q.constructorId).poles++;
                                const c = data.circuits[scheduleMap[q.raceId].circuitId];
                                if (c) c.poles[q.driverId] = (c.poles[q.driverId] || 0) + 1;
                            }
                        }
                    });

                    // Lookup & Pits
                    const resLookup = {};
                    (fetchedData["Race_Results.csv"] || []).forEach(r => resLookup[`${r.raceId}-${r.driverId}`] = r.constructorId);
                    (fetchedData["Pit_Stop_Records.csv"] || []).forEach(p => {
                        const dur = parseFloat(p.duration);
                        if (dur && dur < 30) {
                            data.pitStops.push(dur);
                            const cid = resLookup[`${p.raceId}-${p.driverId}`];
                            if (cid) {
                                const ts = getStat(data.teamStats, cid);
                                ts.pitAvg = ((ts.pitAvg * ts.pitCount) + dur) / (ts.pitCount + 1); ts.pitCount++;
                                if (scheduleMap[p.raceId]) {
                                    const yts = getYearStat(scheduleMap[p.raceId].year, 'team', cid);
                                    yts.pitAvg = ((yts.pitAvg * yts.pitCount) + dur) / (yts.pitCount + 1); yts.pitCount++;
                                }
                            }
                        }
                    });

                    // Status Map
                    const statusMap = {};
                    (fetchedData["Race_Status.csv"] || []).forEach(s => statusMap[s.statusId] = s.status);

                    // Results
                    (fetchedData["Race_Results.csv"] || []).forEach(r => {
                        const did=r.driverId, cid=r.constructorId, pos=parseInt(r.position), pts=parseFloat(r.points)||0, rid=r.raceId;
                        if(!did) return;
                        const ds = getStat(data.driverStats, did), ts = getStat(data.teamStats, cid);
                        ds.races++; ts.races++; ds.pts+=pts; ts.pts+=pts;
                        if(pos===1){ ds.wins++; ts.wins++; } if(pos<=3){ ds.pods++; ts.pods++; } if(pts>0){ ds.scored++; ts.scored++; }

                        const status = statusMap[r.statusId] || "Finished";
                        const isFinished = status === "Finished" || status.includes("+");
                        if (!isFinished) {
                            ds.dnfs++; ts.dnfs++;
                            let type = "Other";
                            if (status.match(/Accident|Collision/i)) type = "Accident";
                            else if (status.match(/Engine|Gearbox|Hydraulics|Brakes|Power/i)) type = "Mechanical";
                            
                            data.retirementCauses[type] = (data.retirementCauses[type] || 0) + 1;
                            if (type === "Mechanical") ts.reliability.mechanical++;
                            else if (type === "Accident") ts.reliability.accident++;

                            if(scheduleMap[rid]) {
                                const y = scheduleMap[rid].year;
                                if(!data.yearlyStats[y]) data.yearlyStats[y] = { driverStats: {}, teamStats: {}, retirementCauses: {} };
                                data.yearlyStats[y].retirementCauses[type] = (data.yearlyStats[y].retirementCauses[type] || 0) + 1;
                                
                                const yts = getYearStat(y, 'team', cid);
                                yts.dnfs++;
                                if (type === "Mechanical") yts.reliability.mechanical++;
                                else if (type === "Accident") yts.reliability.accident++;
                            }
                        }
                        
                        if(scheduleMap[rid]) {
                            const y = scheduleMap[rid].year, yds = getYearStat(y,'driver',did), yts = getYearStat(y,'team',cid);
                            yds.races++; yts.races++; yds.pts+=pts; yts.pts+=pts; 
                            if(pos===1) { yds.wins++; yts.wins++; data.recentResults.push({race: scheduleMap[rid].name, year: y, winner: did, team: cid, date: scheduleMap[rid].date}); 
                                const c = data.circuits[scheduleMap[rid].circuitId]; if(c) { c.winners[did]=(c.winners[did]||0)+1; c.recentWinners.unshift({year:y, driver:did, team:cid}); }
                            }
                            if(pos<=3) { yds.pods++; yts.pods++; } if(pts>0) { yds.scored++; yts.scored++; }
                            const raceIdx = seasonHelper[y].raceOrder.indexOf(scheduleMap[rid].name);
                            if(raceIdx !== -1) {
                                if(!seasonHelper[y].pointsHistory[did]) seasonHelper[y].pointsHistory[did] = new Array(seasonHelper[y].raceOrder.length).fill(0);
                                seasonHelper[y].pointsHistory[did][raceIdx] += pts;
                            }
                        }
                    });
                    
                    Object.keys(seasonHelper).forEach(y => {
                        const s = seasonHelper[y], dStandings = {}, tStandings = {};
                        if(data.yearlyStats[y]) { Object.entries(data.yearlyStats[y].driverStats).forEach(([id, st]) => dStandings[id] = st.pts); Object.entries(data.yearlyStats[y].teamStats).forEach(([id, st]) => tStandings[id] = st.pts); }
                        const dChamp = Object.keys(dStandings).reduce((a,b)=>dStandings[a]>dStandings[b]?a:b, null), tChamp = Object.keys(tStandings).reduce((a,b)=>tStandings[a]>tStandings[b]?a:b, null);
                        const cleanHist = {}; Object.keys(dStandings).sort((a,b)=>dStandings[b]-dStandings[a]).slice(0,5).forEach(did => { let sum=0; cleanHist[did] = (s.pointsHistory[did]||[]).map(p => sum+=p); });
                        data.seasons[y] = { year: y, races: s.raceOrder.length, driverChampId: dChamp, teamChampId: tChamp, driverStandings: dStandings, pointsHistory: cleanHist, raceOrder: s.raceOrder };
                    });

                    // Convert dicts to arrays for charts
                    data.retirementCauses = Object.entries(data.retirementCauses).map(([name, value]) => ({ name, value })).sort((a, b) => b.value - a.value);
                    Object.keys(data.yearlyStats).forEach(y => {
                         data.yearlyStats[y].retirementCauses = Object.entries(data.yearlyStats[y].retirementCauses).map(([name, value]) => ({ name, value })).sort((a, b) => b.value - a.value);
                    });

                    data.recentResults.sort((a,b)=>new Date(b.date)-new Date(a.date));
                    addLog("System Ready."); setTimeout(() => onDataLoaded(data), 800);
                } catch (err) { setError("Connection Error: " + err); setLoading(false); }
            };

            return (
                <div className="fixed inset-0 bg-black/90 backdrop-blur-sm flex items-center justify-center z-50 p-4 animate-in fade-in zoom-in duration-300">
                    <div className="card p-8 max-w-xl w-full border-t-4 border-t-green-500">
                        <div className="flex justify-between mb-6">
                            <div><h2 className="text-2xl font-bold text-white mb-1 flex items-center gap-3 font-display"><Icons.Database className="w-5 h-5 text-green-500" /> ORACLE TELEMETRY UPLINK</h2><p className="text-slate-400 text-xs font-mono uppercase">Secure Gateway // Port: 87a8f04</p></div>
                        </div>
                        <div className="bg-black/40 p-4 rounded-lg font-mono text-xs text-green-400 h-48 overflow-y-auto border border-slate-800 mb-6">{logs.map((l, i) => <div key={i}>{l}</div>)}</div>
                        {error && <div className="text-red-400 text-sm mb-4">{error}</div>}
                        <button onClick={fetchAndProcess} disabled={loading} className={`w-full py-4 rounded-lg font-bold tracking-widest uppercase ${loading?'bg-slate-800':'bg-green-600 hover:bg-green-500 text-white'}`}>{loading?"ESTABLISHING LINK...":"ESTABLISH LINK"}</button>
                    </div>
                </div>
            );
        };

        const StatCard = ({ title, value, Icon, color = "text-white" }) => (
            <div className="card p-6 flex items-center gap-5 group hover:-translate-y-1 transition-all duration-300 bg-gradient-to-br from-slate-900/80 to-slate-900/40">
                <div className={`p-3 rounded-lg bg-slate-800/50 group-hover:scale-110 transition-transform duration-300 border border-slate-700/50 ${color}`}><Icon className="w-6 h-6" /></div>
                <div><div className="text-slate-400 text-[10px] uppercase tracking-widest font-bold mb-1 opacity-80">{title}</div><div className="text-2xl font-mono font-bold text-white tracking-tight group-hover:text-white transition-colors">{value}</div></div>
            </div>
        );

        const CustomTooltip = ({ active, payload, label }) => {
            if (active && payload && payload.length) {
                return ( <div className="custom-tooltip"><p className="text-slate-400 text-[10px] mb-1 uppercase tracking-wider font-bold">{label}</p>{payload.map((entry, index) => ( <div key={index} className="text-xs font-bold font-mono" style={{ color: entry.color }}>{entry.name}: {entry.value.toLocaleString()}</div> ))}</div> );
            }
            return null;
        };

        const DriverComparison = ({ data }) => {
            const [d1, setD1] = useState(""); const [d2, setD2] = useState("");
            const drivers = Object.entries(data.driverStats).sort((a,b) => b[1].wins - a[1].wins).map(([id, s]) => ({ id, name: data.drivers[id]?.name }));
            const getStats = (id) => data.driverStats[id] || { wins: 0, pods: 0, poles: 0, dnfs: 0, pts: 0, races: 1 };
            const s1 = getStats(d1); const s2 = getStats(d2);
            const maxValues = { wins: Math.max(s1.wins, s2.wins, 1), pods: Math.max(s1.pods, s2.pods, 1), poles: Math.max(s1.poles, s2.poles, 1), pts: Math.max(s1.pts, s2.pts, 1), races: Math.max(s1.races, s2.races, 1) };
            const radarData = [ { subject: 'Wins', A: (s1.wins/maxValues.wins)*100, B: (s2.wins/maxValues.wins)*100 }, { subject: 'Podiums', A: (s1.pods/maxValues.pods)*100, B: (s2.pods/maxValues.pods)*100 }, { subject: 'Poles', A: (s1.poles/maxValues.poles)*100, B: (s2.poles/maxValues.poles)*100 }, { subject: 'Points', A: (s1.pts/maxValues.pts)*100, B: (s2.pts/maxValues.pts)*100 }, { subject: 'Exp.', A: (s1.races/maxValues.races)*100, B: (s2.races/maxValues.races)*100 } ];
            return ( <div className="h-full flex flex-col gap-8 animate-in fade-in zoom-in duration-300"><div className="grid grid-cols-2 gap-6"><div className="relative"><select className="w-full bg-slate-900 text-white p-4 rounded-lg border border-slate-800 appearance-none focus:border-red-500 outline-none font-mono text-sm" onChange={e => setD1(e.target.value)} value={d1}><option value="">Select Driver A</option>{drivers.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}</select></div><div className="relative"><select className="w-full bg-slate-900 text-white p-4 rounded-lg border border-slate-800 appearance-none focus:border-blue-500 outline-none font-mono text-sm" onChange={e => setD2(e.target.value)} value={d2}><option value="">Select Driver B</option>{drivers.map(d => <option key={d.id} value={d.id}>{d.name}</option>)}</select></div></div>{d1 && d2 ? ( <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 items-center"><div className="h-96 card p-6 flex justify-center items-center relative"><ResponsiveContainer width="100%" height="100%"><RadarChart cx="50%" cy="50%" outerRadius="70%" data={radarData}><PolarGrid stroke="#334155" strokeDasharray="3 3" /><PolarAngleAxis dataKey="subject" stroke="#94a3b8" tick={{ fill: '#94a3b8', fontSize: 12, fontWeight: 600, fontFamily: 'Chakra Petch' }} /><PolarRadiusAxis angle={30} domain={[0, 100]} stroke="transparent" /><Radar name={data.drivers[d1]?.name} dataKey="A" stroke="#ef4444" strokeWidth={2} fill="#ef4444" fillOpacity={0.2} /><Radar name={data.drivers[d2]?.name} dataKey="B" stroke="#3b82f6" strokeWidth={2} fill="#3b82f6" fillOpacity={0.2} /><Legend /><Tooltip content={<CustomTooltip />} /></RadarChart></ResponsiveContainer></div><div className="space-y-1 card p-6 h-96 overflow-y-auto bg-slate-900/40"><div className="flex justify-between items-center text-[10px] text-slate-500 uppercase tracking-widest border-b border-slate-800 pb-4 mb-4"><span className="text-red-500 font-bold w-1/3 truncate">{data.drivers[d1]?.name}</span><span className="w-1/3 text-center">VS</span><span className="text-blue-500 font-bold w-1/3 text-right truncate">{data.drivers[d2]?.name}</span></div>{[ { l: 'Wins', k: 'wins' }, { l: 'Podiums', k: 'pods' }, { l: 'Poles', k: 'poles' }, { l: 'DNFs', k: 'dnfs' }, { l: 'Points', k: 'pts', fmt: v => v.toFixed(0) }, { l: 'Races', k: 'races' } ].map(row => ( <div key={row.k} className="flex justify-between items-center py-3 border-b border-slate-800/50 hover:bg-slate-800/30 px-2 rounded transition"><span className={`font-mono text-lg w-1/3 ${s1[row.k] > s2[row.k] ? 'text-red-400 font-bold' : 'text-slate-600'}`}>{row.fmt ? row.fmt(s1[row.k]) : s1[row.k]}</span><span className="text-slate-500 text-[10px] uppercase tracking-wider w-1/3 text-center font-bold">{row.l}</span><span className={`font-mono text-lg w-1/3 text-right ${s2[row.k] > s1[row.k] ? 'text-blue-400 font-bold' : 'text-slate-600'}`}>{row.fmt ? row.fmt(s2[row.k]) : s2[row.k]}</span></div> ))}</div></div> ) : ( <div className="flex flex-col items-center justify-center h-64 text-slate-600 border-2 border-dashed border-slate-800 rounded-xl bg-slate-900/20"><Icons.Swords className="w-12 h-12 mb-4 opacity-20" /><p className="text-xs uppercase tracking-widest font-bold">Select Drivers to Compare</p></div> )}</div> );
        };

        // --- STRATEGY VIEW ---
        const StrategyView = ({ data }) => {
            const [year, setYear] = useState('All Time');
            const [track, setTrack] = useState('');
            
            const availableYears = useMemo(() => ["All Time", ...Object.keys(data.seasons || {}).sort((a, b) => b - a)], [data.seasons]);
            const tracks = useMemo(() => Object.values(data.circuits).sort((a,b) => a.name.localeCompare(b.name)), [data]);

            // Filter Logic
            const stats = useMemo(() => {
                const source = (year === 'All Time' || !data.yearlyStats[year]) ? data.teamStats : data.yearlyStats[year].teamStats;
                
                // Reliability Chart Data
                const reliability = Object.entries(source)
                    .filter(([id, s]) => data.teams[id] && s.dnfs > 0)
                    .map(([id, s]) => ({ 
                        name: data.teams[id].name, 
                        mech: s.reliability?.mechanical || 0, 
                        acc: s.reliability?.accident || 0 
                    }))
                    .sort((a, b) => (b.mech + b.acc) - (a.mech + a.acc))
                    .slice(0, 10);
                    
                // Attrition Data (Simulated per track filtering if track selected)
                // In a real scenario with full data, we'd filter results by trackId AND year
                // Here we approximate with global track stats or year stats
                const attrition = year === 'All Time' ? data.retirementCauses : (data.yearlyStats[year]?.retirementCauses || []);

                return { reliability, attrition };
            }, [data, year, track]);

            return (
                <div className="space-y-8 animate-in fade-in">
                    <div className="flex gap-4 mb-6">
                        <select value={year} onChange={e => setYear(e.target.value)} className="bg-slate-900 text-white px-4 py-2 rounded border border-slate-700 text-xs font-mono uppercase">
                            {availableYears.map(y => <option key={y} value={y}>{y}</option>)}
                        </select>
                        <select value={track} onChange={e => setTrack(e.target.value)} className="bg-slate-900 text-white px-4 py-2 rounded border border-slate-700 text-xs font-mono uppercase">
                            <option value="">All Tracks</option>
                            {tracks.map(t => <option key={t.name} value={t.name}>{t.name}</option>)}
                        </select>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div className="card p-6">
                            <div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-4">
                                <h3 className="text-lg font-bold text-white tracking-wide flex items-center gap-2"><Icons.Wrench className="w-5 h-5 text-red-500"/> RELIABILITY MATRIX</h3>
                            </div>
                            <div className="h-80">
                                <ResponsiveContainer width="100%" height="100%">
                                    <BarChart data={stats.reliability} layout="vertical" margin={{left: 40}}>
                                        <CartesianGrid strokeDasharray="3 3" stroke="#1e293b" horizontal={false}/>
                                        <XAxis type="number" hide />
                                        <YAxis dataKey="name" type="category" width={120} style={{fontSize:'10px', fill:'#94a3b8', fontFamily:'Chakra Petch'}} />
                                        <Tooltip content={<CustomTooltip />} />
                                        <Legend />
                                        <Bar dataKey="mech" name="Mechanical" stackId="a" fill="#ef4444" radius={[0,0,0,0]} />
                                        <Bar dataKey="acc" name="Accident" stackId="a" fill="#f59e0b" radius={[0,4,4,0]} />
                                    </BarChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                        
                        <div className="card p-6">
                            <div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-4">
                                <h3 className="text-lg font-bold text-white tracking-wide flex items-center gap-2"><Icons.AlertTriangle className="w-5 h-5 text-yellow-500"/> ATTRITION CAUSES</h3>
                            </div>
                            <div className="h-80">
                                <ResponsiveContainer width="100%" height="100%">
                                    <PieChart>
                                        <Pie data={stats.attrition} cx="50%" cy="50%" innerRadius={60} outerRadius={80} paddingAngle={5} dataKey="value">
                                            {stats.attrition.map((e,i) => <Cell key={i} fill={PIE_COLORS[i%PIE_COLORS.length]} />)}
                                        </Pie>
                                        <Tooltip content={<CustomTooltip />} />
                                        <Legend verticalAlign="bottom" layout="vertical" align="right" />
                                    </PieChart>
                                </ResponsiveContainer>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [data, setData] = useState(INITIAL_DATA);
            const [view, setView] = useState("dashboard");
            const [showUploader, setShowUploader] = useState(false);
            const [showSettings, setShowSettings] = useState(false);
            const [userApiKey, setUserApiKey] = useState("");
            const [isDemo, setIsDemo] = useState(true);
            const [searchTerm, setSearchTerm] = useState("");
            const [selectedId, setSelectedId] = useState(null);
            const [selectedYear, setSelectedYear] = useState("All Time");
            const [archiveYear, setArchiveYear] = useState("All Time");
            const [archiveType, setArchiveType] = useState("drivers");
            const [aiLoading, setAiLoading] = useState(false);
            const [aiReport, setAiReport] = useState(null);

            useEffect(() => { const storedKey = localStorage.getItem("f1_gemini_key"); if (storedKey) setUserApiKey(storedKey); }, []);
            const handleSaveKey = (key) => { setUserApiKey(key); localStorage.setItem("f1_gemini_key", key); setShowSettings(false); };
            const handleDataLoaded = (newData) => { if (newData) { setData(newData); setIsDemo(false); } setShowUploader(false); };

            const generateReport = async (promptContext) => {
                setAiLoading(true); setAiReport(null);
                try { const response = await callGemini(userApiKey, `Analyze: ${JSON.stringify(promptContext)}`); setAiReport(response); } catch (e) { setAiReport(e.message); } finally { setAiLoading(false); }
            };

            const availableYears = useMemo(() => ["All Time", ...Object.keys(data.seasons || {}).sort((a, b) => b - a)], [data.seasons]);
            const currentStats = useMemo(() => {
                if (selectedYear === "All Time" || !data.yearlyStats || !data.yearlyStats[selectedYear]) return { drivers: data.driverStats, teams: data.teamStats, causes: data.retirementCauses, races: data.recentResults.length };
                return { drivers: data.yearlyStats[selectedYear].driverStats, teams: data.yearlyStats[selectedYear].teamStats, causes: data.yearlyStats[selectedYear].retirementCauses, races: data.seasons[selectedYear]?.races || 0 };
            }, [data, selectedYear]);
            
            const topDrivers = useMemo(() => Object.entries(currentStats.drivers || {}).filter(([id]) => data.drivers[id]).map(([id, s]) => ({ id, ...s, name: data.drivers[id].name })).sort((a, b) => b.wins - a.wins).slice(0, 10), [currentStats, data.drivers]);
            const topPitTeams = useMemo(() => Object.entries(currentStats.teams || {}).filter(([id]) => data.teams[id] && currentStats.teams[id].pitCount > (selectedYear==="All Time"?5:1)).map(([id, s]) => ({ id, ...s, name: data.teams[id].name })).sort((a, b) => a.pitAvg - b.pitAvg).slice(0, 10), [currentStats, data.teams, selectedYear]);

            const renderDashboard = () => (
                <div className="space-y-8 animate-in fade-in duration-500">
                    <div className="flex justify-between items-center"><h2 className="text-lg font-bold text-white uppercase tracking-widest font-display">System Overview</h2><select value={selectedYear} onChange={(e) => setSelectedYear(e.target.value)} className="bg-slate-900 text-white px-4 py-2 rounded border border-slate-700 text-xs font-mono focus:border-red-500 outline-none uppercase font-bold tracking-wider">{availableYears.map(y => <option key={y} value={y}>{y}</option>)}</select></div>
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6"><StatCard title="Total Races" value={selectedYear==="All Time"?(isDemo?"1,100+":data.recentResults.length):currentStats.races} Icon={Icons.Flag} color="text-red-500" /><StatCard title="Active Drivers" value={Object.keys(currentStats.drivers).length} Icon={Icons.Users} color="text-blue-500" /><StatCard title="Seasons" value={selectedYear==="All Time"?Object.keys(data.seasons||{}).length:1} Icon={Icons.Calendar} color="text-purple-500" /><StatCard title="Win Leader" value={`${(topDrivers[0]?.name||'N/A').split(' ').pop()} (${topDrivers[0]?.wins||0})`} Icon={Icons.Trophy} color="text-yellow-500" /></div>
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-8"><div className="card p-6"><div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-4"><h3 className="text-sm font-bold text-white tracking-widest uppercase font-display flex items-center gap-2"><span className="w-1.5 h-4 bg-red-600 rounded-sm"></span>Victory Leaders</h3><span className="text-[10px] text-slate-500 font-mono uppercase tracking-wider">{selectedYear} Wins</span></div><div className="h-80"><ResponsiveContainer width="100%" height="100%"><BarChart data={topDrivers} layout="vertical" margin={{ left: 20 }}><defs><linearGradient id="gradWins" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stopColor="#ef4444" stopOpacity={0.8}/><stop offset="100%" stopColor="#ef4444" stopOpacity={0.2}/></linearGradient></defs><CartesianGrid strokeDasharray="3 3" stroke="#1e293b" horizontal={false} /><XAxis type="number" hide /><YAxis dataKey="name" type="category" width={130} style={{fontSize:'11px', fontWeight:'600', fill:'#94a3b8', fontFamily:'Chakra Petch'}} /><Tooltip content={<CustomTooltip />} /><Bar dataKey="wins" fill="url(#gradWins)" radius={[0, 4, 4, 0]} barSize={20} /></BarChart></ResponsiveContainer></div></div><div className="card p-6"><div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-4"><h3 className="text-sm font-bold text-white tracking-widest uppercase font-display flex items-center gap-2"><span className="w-1.5 h-4 bg-green-500 rounded-sm"></span>Pit Crew Elite</h3><span className="text-[10px] text-green-500 font-mono uppercase tracking-wider">Avg Stop (s)</span></div>{topPitTeams.length>0?<div className="h-80"><ResponsiveContainer width="100%" height="100%"><BarChart data={topPitTeams} layout="vertical" margin={{ left: 20 }}><defs><linearGradient id="gradPit" x1="0" y1="0" x2="1" y2="0"><stop offset="0%" stopColor="#10b981" stopOpacity={0.8}/><stop offset="100%" stopColor="#10b981" stopOpacity={0.2}/></linearGradient></defs><XAxis type="number" domain={[0, 'auto']} hide /><YAxis dataKey="name" type="category" width={130} style={{fontSize:'11px', fontWeight:'600', fill:'#94a3b8', fontFamily:'Chakra Petch'}} /><Tooltip content={<CustomTooltip />} /><Bar dataKey="pitAvg" fill="url(#gradPit)" radius={[0, 4, 4, 0]} barSize={20} /></BarChart></ResponsiveContainer></div>:<div className="h-80 flex items-center justify-center text-slate-600 text-xs uppercase tracking-widest font-bold border border-dashed border-slate-800 rounded bg-slate-900/20">Insufficient Data</div>}</div></div>
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8"><div className="card p-6 lg:col-span-1"><div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-4"><h3 className="text-sm font-bold text-white tracking-widest uppercase font-display">Attrition</h3><span className="text-[10px] text-slate-500 font-mono uppercase tracking-wider">DNF Causes</span></div><div className="h-64"><ResponsiveContainer><PieChart><Pie data={Array.isArray(currentStats.causes) ? currentStats.causes : []} cx="50%" cy="50%" innerRadius={50} outerRadius={80} paddingAngle={4} dataKey="value" stroke="none">{Array.isArray(currentStats.causes) && currentStats.causes.map((e,i) => <Cell key={i} fill={PIE_COLORS[i%PIE_COLORS.length]} />)}</Pie><Tooltip content={<CustomTooltip />} /><Legend verticalAlign="bottom" iconType="circle" wrapperStyle={{fontSize:'10px', fontFamily:'Inter'}} /></PieChart></ResponsiveContainer></div></div><div className="card p-6 lg:col-span-2"><div className="flex justify-between items-center mb-6 border-b border-slate-800 pb-4"><h3 className="text-sm font-bold text-white tracking-widest uppercase font-display">Race Log</h3><span className="text-[10px] text-slate-500 font-mono uppercase tracking-wider">Recent GPs</span></div><div className="overflow-x-auto"><table className="w-full text-left text-sm text-slate-400"><thead className="bg-slate-900/50 text-slate-200 uppercase font-bold text-[10px] tracking-widest"><tr><th className="px-6 py-4 rounded-l-lg">Year</th><th className="px-6 py-4">Grand Prix</th><th className="px-6 py-4">Winner</th><th className="px-6 py-4 rounded-r-lg">Team</th></tr></thead><tbody className="divide-y divide-slate-800/50">{data.recentResults.filter(r => selectedYear === "All Time" || r.year.toString() === selectedYear).slice(0, 6).map((r, i) => (<tr key={i} className="hover:bg-white/5 transition duration-150"><td className="px-6 py-4 font-mono text-xs text-slate-500">{r.year}</td><td className="px-6 py-4 text-white font-bold text-xs uppercase tracking-wide">{r.race}</td><td className="px-6 py-4 text-slate-300 flex items-center gap-2 text-xs font-mono"><span className="w-1 h-1 bg-red-500 rounded-full"></span>{data.drivers[r.winner]?.name}</td><td className="px-6 py-4 text-slate-500 text-xs uppercase font-bold tracking-wider">{data.teams[r.team]?.name}</td></tr>))}</tbody></table></div></div></div>
                </div>
            );
            
            // Simplified List Renderers to save space but keep logic identical
            const renderArchive = () => {
                const targetStats = (archiveYear === "All Time" || !data.yearlyStats[archiveYear]) ? (archiveType === 'drivers' ? data.driverStats : data.teamStats) : (archiveType === 'drivers' ? data.yearlyStats[archiveYear].driverStats : data.yearlyStats[archiveYear].teamStats);
                const source = archiveType === 'drivers' ? data.drivers : data.teams;
                const list = Object.entries(source).map(([id, obj]) => ({ id, name: obj.name, sub: obj.nat, stats: targetStats[id] || { wins: 0, pods: 0, pts: 0, races: 0 } })).filter(item => item.name.toLowerCase().includes(searchTerm.toLowerCase()) && (archiveYear === "All Time" || item.stats.races > 0)).sort((a, b) => b.stats.pts - a.stats.pts);

                return (
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 h-[calc(100vh-140px)] animate-in slide-in-from-bottom-4">
                        <div className="card flex flex-col h-full overflow-hidden border-slate-800"><div className="p-6 border-b border-slate-800 bg-slate-900/30 space-y-4"><div className="flex gap-2"><select value={archiveYear} onChange={(e) => setArchiveYear(e.target.value)} className="w-1/2 bg-slate-900 border border-slate-700 rounded-lg p-3 text-white text-xs font-bold uppercase font-mono">{["All Time", ...Object.keys(data.seasons).sort((a,b)=>b-a)].map(y=><option key={y} value={y}>{y}</option>)}</select><select value={archiveType} onChange={(e) => {setArchiveType(e.target.value); setSelectedId(null);}} className="w-1/2 bg-slate-900 border border-slate-700 rounded-lg p-3 text-white text-xs font-bold uppercase font-mono"><option value="drivers">Drivers</option><option value="teams">Constructors</option></select></div><input type="text" placeholder="SEARCH..." className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white font-mono text-xs" onChange={e => setSearchTerm(e.target.value)} /></div><div className="flex-1 overflow-y-auto p-4 space-y-2 scroll-hide">{list.map(item => ( <div key={item.id} onClick={() => {setSelectedId(item.id); setAiReport(null);}} className={`p-4 rounded-lg cursor-pointer flex justify-between items-center border transition ${selectedId === item.id ? 'bg-blue-900/20 border-blue-500' : 'bg-slate-900/40 border-transparent hover:bg-slate-800'}`}><div><div className="text-white font-bold text-xs uppercase">{item.name}</div></div><div className="text-right font-mono font-bold">{item.stats.pts.toLocaleString()} PTS</div></div> ))}</div></div>
                        <div className="lg:col-span-2 card p-8 flex flex-col justify-center items-center h-full relative overflow-hidden bg-slate-900/50">
                            {selectedId ? (() => { 
                                const item = list.find(i => i.id === selectedId); 
                                if (!item) return null;
                                return (
                                    <div className="w-full h-full overflow-y-auto scroll-hide space-y-6">
                                        <div className="flex justify-between items-start border-b border-slate-800 pb-6">
                                            <div><div className="text-xs text-blue-500 font-mono mb-1 uppercase">{archiveYear} Profile</div><div className="text-4xl font-black text-white uppercase font-display">{item.name}</div><div className="text-sm text-slate-500 font-bold uppercase">{item.sub}</div></div>
                                            <button onClick={() => generateReport(item)} disabled={aiLoading} className="flex items-center gap-2 px-4 py-2 bg-gradient-to-r from-blue-600 to-purple-600 rounded-lg text-xs font-bold uppercase hover:shadow-lg transition disabled:opacity-50"><Icons.Sparkles className="w-4 h-4"/> {aiLoading ? "Analyzing..." : "Generate Report"}</button>
                                        </div>
                                        {aiReport && <div className="bg-blue-900/10 border border-blue-500/30 p-4 rounded-lg text-sm text-slate-300 ai-response animate-in fade-in" dangerouslySetInnerHTML={{ __html: marked.parse(aiReport) }}></div>}
                                        <div className="grid grid-cols-4 gap-4">
                                            {[{l:'Wins',v:item.stats.wins},{l:'Podiums',v:item.stats.pods},{l:'Poles',v:item.stats.poles},{l:'DNFs',v:item.stats.dnfs}].map((s,i) => <div key={i} className="bg-slate-950/50 p-4 rounded border border-slate-800 text-center"><div className="text-[10px] text-slate-500 uppercase font-bold">{s.l}</div><div className="text-2xl font-mono font-bold text-white">{s.v}</div></div>)}
                                        </div>
                                    </div>
                                );
                            })() : <div className="text-center opacity-30"><Icons.MousePointer2 className="w-20 h-20 mx-auto mb-4"/><p className="font-mono uppercase">Select Driver/Team</p></div>}
                        </div>
                    </div>
                );
            };

            // Render Circuits
            const renderCircuits = () => {
                const list = Object.entries(data.circuits || {}).map(([id, c]) => ({ id, ...c })).sort((a, b) => b.races - a.races);
                return (
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 h-[calc(100vh-140px)] animate-in slide-in-from-bottom-4">
                        <div className="card flex flex-col h-full overflow-hidden border-slate-800"><div className="p-6 border-b border-slate-800 bg-slate-900/30"><input type="text" placeholder="SEARCH TRACKS..." className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-red-500 outline-none transition font-mono text-xs font-bold uppercase tracking-wider" onChange={e => setSearchTerm(e.target.value)} /></div><div className="flex-1 overflow-y-auto p-4 space-y-2 scroll-hide">{list.filter(c => c.name.toLowerCase().includes(searchTerm.toLowerCase())).map(item => ( <div key={item.id} onClick={() => setSelectedId(item.id)} className={`p-4 rounded-lg cursor-pointer flex justify-between items-center transition-all duration-200 border ${selectedId === item.id ? 'bg-red-600/10 border-red-500/50' : 'bg-slate-900/40 border-transparent hover:bg-slate-800 hover:border-slate-700'}`}><div><div className="text-white font-bold text-sm font-display">{item.name}</div><div className="text-[10px] text-slate-500 uppercase mt-1 font-bold tracking-wider">{item.location}, {item.country}</div></div><div className="text-right"><div className="text-sm font-bold text-white">{item.races}</div><div className="text-[9px] text-slate-600 uppercase tracking-widest font-bold">GPs</div></div></div> ))}</div></div>
                        <div className="lg:col-span-2 card p-8 flex flex-col justify-center items-center h-full relative overflow-hidden bg-gradient-to-br from-slate-900/80 to-slate-950">
                            {selectedId ? ( (() => { const track = list.find(i => i.id === selectedId); if (!track) return null; 
                                const topWinner = Object.entries(track.winners).sort((a,b) => b[1] - a[1])[0]; 
                                const topPole = Object.entries(track.poles).sort((a,b) => b[1] - a[1])[0];
                                const recentWins = track.recentWinners.slice(0, 5);

                                return ( 
                                    <div className="w-full h-full overflow-y-auto scroll-hide space-y-8 animate-in fade-in">
                                        <div className="text-center"><div className="text-6xl font-black text-white mb-2 tracking-tighter font-display uppercase">{track.name}</div><div className="inline-block px-4 py-1 rounded-full bg-slate-900/80 text-[10px] font-mono text-slate-400 border border-slate-700 uppercase tracking-[0.2em] font-bold">{track.location}, {track.country}</div></div>
                                        <div className="grid grid-cols-2 gap-6">
                                            <div className="bg-slate-900/60 p-6 rounded-xl border border-slate-800 flex items-center gap-4"><div className="p-3 bg-yellow-500/10 rounded-lg"><Icons.Trophy className="w-6 h-6 text-yellow-500" /></div><div><div className="text-[9px] text-slate-500 uppercase tracking-widest font-bold mb-1">Most Wins</div><div className="text-xl font-bold text-white">{topWinner ? data.drivers[topWinner[0]]?.name : 'N/A'}</div><div className="text-xs text-yellow-500 font-mono">{topWinner ? topWinner[1] : 0} Wins</div></div></div>
                                            <div className="bg-slate-900/60 p-6 rounded-xl border border-slate-800 flex items-center gap-4"><div className="p-3 bg-purple-500/10 rounded-lg"><Icons.Flag className="w-6 h-6 text-purple-500" /></div><div><div className="text-[9px] text-slate-500 uppercase tracking-widest font-bold mb-1">Pole King</div><div className="text-xl font-bold text-white">{topPole ? data.drivers[topPole[0]]?.name : 'N/A'}</div><div className="text-xs text-purple-500 font-mono">{topPole ? topPole[1] : 0} Poles</div></div></div>
                                        </div>
                                        <div className="bg-slate-900/60 p-6 rounded-xl border border-slate-800">
                                            <h4 className="text-slate-400 font-bold mb-6 text-[10px] uppercase tracking-[0.2em]">Recent Winners</h4>
                                            <div className="overflow-x-auto"><table className="w-full text-left text-sm text-slate-400"><thead className="bg-slate-800/50 text-slate-200 uppercase font-bold text-[10px] tracking-widest"><tr><th className="px-4 py-3 rounded-l-lg">Year</th><th className="px-4 py-3">Driver</th><th className="px-4 py-3 rounded-r-lg">Team</th></tr></thead><tbody className="divide-y divide-slate-800/50">{recentWins.map((r, i) => (<tr key={i} className="hover:bg-white/5 transition"><td className="px-4 py-3 font-mono text-xs text-slate-500">{r.year}</td><td className="px-4 py-3 text-white font-bold text-xs">{data.drivers[r.driver]?.name}</td><td className="px-4 py-3 text-slate-400 text-xs uppercase">{data.teams[r.team]?.name}</td></tr>))}</tbody></table></div>
                                        </div>
                                    </div> 
                                ); })() ) : <div className="text-center opacity-30"><Icons.Map className="w-20 h-20 mx-auto mb-4 opacity-50" /><p className="text-lg font-mono uppercase tracking-widest">Select Track</p></div>}
                        </div>
                    </div>
                );
            }

            const renderSeasons = () => {
                const list = Object.values(data.seasons).sort((a, b) => b.year - a.year).map(s => ({ id: s.year.toString(), name: s.year.toString(), sub: `${s.races} Rounds`, rightMain: data.drivers[s.driverChampId]?.name || "Unknown", rightSub: "Champion", data: s }));
                return ( <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 h-[calc(100vh-140px)] animate-in slide-in-from-bottom-4"><div className="card flex flex-col h-full overflow-hidden border-slate-800"><div className="p-6 border-b border-slate-800 bg-slate-900/30"><input type="text" placeholder="SEARCH SEASON..." className="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-white focus:border-red-500 outline-none transition font-mono text-xs font-bold uppercase tracking-wider" onChange={e => setSearchTerm(e.target.value)} /></div><div className="flex-1 overflow-y-auto p-4 space-y-2 scroll-hide">{list.map(item => ( <div key={item.id} onClick={() => setSelectedId(item.id)} className={`p-4 rounded-lg cursor-pointer flex justify-between items-center transition-all duration-200 border ${selectedId === item.id ? 'bg-red-600/10 border-red-500/50' : 'bg-slate-900/40 border-transparent hover:bg-slate-800 hover:border-slate-700'}`}><div><div className="text-white font-bold text-sm font-mono">{item.name}</div><div className="text-[10px] text-slate-500 uppercase mt-1 font-bold tracking-wider">{item.sub}</div></div><div className="text-right"><div className="text-sm font-bold text-white truncate w-32 text-right uppercase">{item.rightMain}</div><div className="text-[9px] text-slate-600 uppercase tracking-widest font-bold">{item.rightSub}</div></div></div> ))}</div></div><div className="lg:col-span-2 card p-8 flex flex-col justify-center items-center h-full relative overflow-hidden bg-gradient-to-br from-slate-900/80 to-slate-950">{selectedId ? ( (() => { const item = list.find(i => i.id === selectedId); if (!item) return null; const s = item.data; const topDrivers = Object.entries(s.driverStandings).sort((a,b) => b[1] - a[1]).slice(0, 5).map(([id, pts]) => ({ id, name: data.drivers[id]?.name, pts })); const chartData = s.raceOrder.map((raceName, idx) => { const point = { name: raceName }; topDrivers.forEach(d => { if (s.pointsHistory && s.pointsHistory[d.id]) point[d.name] = s.pointsHistory[d.id][idx]; }); return point; }); return ( <div className="w-full h-full overflow-y-auto scroll-hide space-y-8 animate-in fade-in"><div className="text-center"><div className="text-8xl font-black text-white mb-2 tracking-tighter opacity-90 font-display">{s.year}</div><div className="inline-block px-4 py-1 rounded-full bg-slate-900/80 text-[10px] font-mono text-slate-400 border border-slate-700 uppercase tracking-[0.2em] font-bold">{s.races} Rounds Completed</div></div>{s.pointsHistory && ( <div className="bg-slate-900/60 p-6 rounded-xl border border-slate-800"><h4 className="text-slate-400 font-bold mb-6 text-[10px] uppercase tracking-[0.2em] flex items-center gap-2"><span className="w-1.5 h-1.5 bg-red-500 rounded-full animate-pulse"></span> Title Fight</h4><div className="h-72"><ResponsiveContainer width="100%" height="100%"><LineChart data={chartData}><CartesianGrid strokeDasharray="3 3" stroke="#1e293b" /><XAxis dataKey="name" stroke="#64748b" style={{fontSize:'9px', fontFamily:'Inter', fontWeight:'600'}} /><YAxis stroke="#64748b" width={30} style={{fontSize:'10px', fontFamily:'Chakra Petch'}} /><Tooltip content={<CustomTooltip />} /><Legend wrapperStyle={{fontSize:'10px', fontFamily:'Inter', textTransform:'uppercase', fontWeight:'bold'}} />{topDrivers.map((d, i) => <Line key={d.id} type="monotone" dataKey={d.name} stroke={COLORS[i % COLORS.length]} dot={false} strokeWidth={3} />)}</LineChart></ResponsiveContainer></div></div> )}<div className="grid grid-cols-2 gap-6"><div className="bg-slate-900/40 p-6 rounded-xl border border-slate-800 text-center hover:border-red-900/30 transition"><div className="text-slate-500 text-[9px] uppercase tracking-[0.2em] font-bold mb-2">Driver Champion</div><div className="text-xl font-bold text-white uppercase font-display">{data.drivers[s.driverChampId]?.name || "N/A"}</div></div><div className="bg-slate-900/40 p-6 rounded-xl border border-slate-800 text-center hover:border-blue-900/30 transition"><div className="text-slate-500 text-[9px] uppercase tracking-[0.2em] font-bold mb-2">Constructor Champion</div><div className="text-xl font-bold text-white uppercase font-display">{data.teams[s.teamChampId]?.name || "N/A"}</div></div></div></div> ); })() ) : <div className="text-center opacity-30"><Icons.MousePointer2 className="w-20 h-20 mx-auto mb-4 opacity-50" /><p className="text-lg font-mono uppercase tracking-widest">Select Season</p></div>}</div></div> );
            }

            return (
                <div className="min-h-screen pb-10 pt-24">
                    {showUploader && <DataFetcher onDataLoaded={d => {if(d){setData(d); setIsDemo(false);} setShowUploader(false);}} />}
                    {showSettings && <SettingsModal isOpen={true} onClose={() => setShowSettings(false)} onSave={handleSaveKey} currentKey={userApiKey} />}

                    <header className="fixed top-0 left-0 right-0 z-40 bg-[#09090b]/90 backdrop-blur-md border-b border-white/5">
                        <div className="max-w-7xl mx-auto px-6 h-20 flex items-center justify-between">
                            <div className="flex items-center gap-4"><div className="w-10 h-10 bg-gradient-to-br from-red-600 to-red-900 rounded-xl flex items-center justify-center font-black italic text-white text-xl border border-red-500/30">F1</div><div><h1 className="font-bold text-lg tracking-tight leading-none text-white font-display">TELEMETRY <span className="text-red-500">HUB</span></h1><span className="text-[10px] text-slate-500 uppercase tracking-[0.3em] font-bold">AI-Powered Analytics</span></div></div>
                            <nav className="hidden md:flex bg-slate-900/50 p-1 rounded-lg border border-white/5">{['dashboard', 'strategy', 'ai gen', 'archives', 'circuits', 'seasons'].map(tab => <button key={tab} onClick={() => { setView(tab); setSelectedId(null); setAiReport(null); }} className={`px-6 py-2 rounded-md text-[10px] font-bold transition-all uppercase tracking-[0.15em] ${view === tab ? 'bg-red-600 text-white shadow-lg' : 'text-slate-400 hover:text-white'}`}>{tab}</button>)}</nav>
                            <div className="flex items-center gap-3">
                                <button onClick={() => setShowSettings(true)} className="p-2 rounded-md bg-slate-800 text-slate-400 hover:text-white transition"><Icons.Settings className="w-4 h-4"/></button>
                                <button onClick={() => setShowUploader(true)} className="group flex items-center gap-2 bg-white text-black px-5 py-2 rounded-md text-[10px] font-bold uppercase tracking-widest transition hover:bg-slate-200"><Icons.Database className="w-3 h-3" /><span>Data</span></button>
                            </div>
                        </div>
                    </header>

                    <main className="max-w-7xl mx-auto px-6 py-8 animate-in fade-in slide-in-from-bottom-8">
                        {view === 'dashboard' && renderDashboard()}
                        {view === 'archives' && renderArchive()}
                        {view === 'circuits' && renderCircuits()}
                        {view === 'seasons' && renderSeasons()}
                        {view === 'strategy' && <StrategyView data={data} />}
                        {view === 'ai gen' && <AIChat userKey={userApiKey} data={data} />}
                        {view === 'compare' && <DriverComparison data={data} />}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
