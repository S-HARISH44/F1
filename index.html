<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F1 Telemetry Hub | Mission Control</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js"></script>
    
    <!-- Prop Types (Required for Recharts UMD) -->
    <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
    
    <!-- Recharts for Visualization -->
    <script src="https://unpkg.com/recharts@2.12.7/umd/Recharts.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Markdown Parser -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Custom Styles for F1 Aesthetic -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Titillium+Web:ital,wght@0,300;0,400;0,600;0,700;1,400&display=swap');
        
        body {
            font-family: 'Titillium Web', sans-serif;
            background-color: #050505;
            color: #e0e0e0;
            overflow-x: hidden;
            background-image: 
                linear-gradient(rgba(102, 252, 241, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(102, 252, 241, 0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        
        /* Scrollbar Customization */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        ::-webkit-scrollbar-track {
            background: #0B0C10; 
        }
        ::-webkit-scrollbar-thumb {
            background: #45A29E; 
            border-radius: 3px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #66FCF1; 
        }

        /* Glassmorphism & UI Elements */
        .glass-panel {
            background: rgba(19, 24, 30, 0.7);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.5);
            transition: all 0.3s ease;
        }
        
        .glass-panel:hover {
            border-color: rgba(102, 252, 241, 0.3);
            box-shadow: 0 0 15px rgba(102, 252, 241, 0.1);
        }

        .neon-text {
            color: #66FCF1;
            text-shadow: 0 0 5px rgba(102, 252, 241, 0.6);
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Table Styles */
        .standings-table th {
            text-transform: uppercase;
            font-size: 0.7rem;
            letter-spacing: 0.1em;
            color: #8892b0;
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid rgba(102, 252, 241, 0.1);
            position: sticky;
            top: 0;
            background: rgba(19, 24, 30, 0.95);
            z-index: 10;
        }
        .standings-table td {
            padding: 0.8rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.02);
        }
        .standings-table tr:hover {
            background-color: rgba(102, 252, 241, 0.05);
        }
        
        /* Chat Bubble Styles */
        .chat-bubble {
            max-width: 80%;
            padding: 12px;
            border-radius: 12px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .chat-user {
            background: rgba(102, 252, 241, 0.1);
            border: 1px solid rgba(102, 252, 241, 0.3);
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }
        .chat-ai {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            align-self: flex-start;
            border-bottom-left-radius: 2px;
        }
        .typing-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background-color: #66FCF1;
            margin-right: 4px;
            animation: typing 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, useRef } = React;
        
        // Ensure Recharts is loaded safely
        const Recharts = window.Recharts || {};
        const { 
            LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, Legend, ResponsiveContainer, 
            AreaChart, Area, ScatterChart, Scatter, BarChart, Bar, Cell, RadarChart, PolarGrid, 
            PolarAngleAxis, PolarRadiusAxis, Radar, PieChart, Pie, ReferenceLine, Label
        } = Recharts;

        // --- GEMINI API CONFIG ---
        const apiKey = ""; // Injected at runtime

        // Helper for exponential backoff
        const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

        const callGemini = async (prompt, contextData) => {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
            
            const systemPrompt = `You are an expert Formula 1 Race Engineer named "Gemini". 
            You are concise, technical, and data-driven, but easy to understand.
            You are analyzing the current race session for the user.
            
            Current Session Context:
            - Year: ${contextData.year}
            - Track: ${contextData.track.name}
            - Weather: Air ${contextData.weather.air}°C, Track ${contextData.weather.track}°C, Rain ${contextData.weather.rain}%
            - Top 3 Drivers: ${contextData.topDrivers.map(d => d.name).join(', ')}
            
            Answer the user's query based on F1 knowledge and this context.
            If asked about strategy, mention undercut windows and tyre degradation based on the track temps.
            Keep responses short (max 3 sentences unless detailed analysis is requested).`;

            const payload = {
                contents: [{
                    parts: [{ text: systemPrompt + "\n\nUser Query: " + prompt }]
                }]
            };

            for (let attempt = 0; attempt < 5; attempt++) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    
                    const data = await response.json();
                    return data.candidates?.[0]?.content?.parts?.[0]?.text || "No response from Race Control.";
                } catch (error) {
                    console.error(`Attempt ${attempt + 1} failed`, error);
                    if (attempt === 4) return "Radio check failed. Connection to Pitwall lost.";
                    await wait(Math.pow(2, attempt) * 1000);
                }
            }
        };

        // --- DATA CONSTANTS ---
        const YEARS = ['2025', '2024', '2023', '2022', '2021', '2020', '2019'];

        // REAL HISTORICAL DATA (Top 5 Drivers & Constructors) - Including 2025 Scenario
        const HISTORICAL_DATA = {
            '2025': {
                drivers: [
                    { rank: 1, id: 'HAM', number: 44, name: 'Lewis Hamilton', team: 'Ferrari', points: 385, wins: 8, podiums: 16, color: '#DC0000' },
                    { rank: 2, id: 'VER', number: 1, name: 'Max Verstappen', team: 'Red Bull Racing', points: 372, wins: 7, podiums: 15, color: '#1E41FF' },
                    { rank: 3, id: 'LEC', number: 16, name: 'Charles Leclerc', team: 'Ferrari', points: 310, wins: 4, podiums: 12, color: '#DC0000' },
                    { rank: 4, id: 'NOR', number: 4, name: 'Lando Norris', team: 'McLaren', points: 295, wins: 3, podiums: 10, color: '#FF8700' },
                    { rank: 5, id: 'PIA', number: 81, name: 'Oscar Piastri', team: 'McLaren', points: 240, wins: 2, podiums: 8, color: '#FF8700' }
                ],
                constructors: [
                    { rank: 1, id: 'ferrari', name: 'Ferrari', points: 695, wins: 12, color: '#DC0000' },
                    { rank: 2, id: 'redbull', name: 'Red Bull Racing', points: 580, wins: 7, color: '#1E41FF' },
                    { rank: 3, id: 'mclaren', name: 'McLaren', points: 535, wins: 5, color: '#FF8700' },
                    { rank: 4, id: 'mercedes', name: 'Mercedes', points: 390, wins: 0, color: '#00D2BE' },
                    { rank: 5, id: 'aston', name: 'Aston Martin', points: 140, wins: 0, color: '#006F62' }
                ]
            },
            '2024': {
                drivers: [
                    { rank: 1, id: 'VER', number: 1, name: 'Max Verstappen', team: 'Red Bull Racing', points: 437, wins: 9, podiums: 14, color: '#1E41FF' },
                    { rank: 2, id: 'NOR', number: 4, name: 'Lando Norris', team: 'McLaren', points: 374, wins: 3, podiums: 12, color: '#FF8700' },
                    { rank: 3, id: 'LEC', number: 16, name: 'Charles Leclerc', team: 'Ferrari', points: 356, wins: 3, podiums: 12, color: '#DC0000' },
                    { rank: 4, id: 'PIA', number: 81, name: 'Oscar Piastri', team: 'McLaren', points: 292, wins: 2, podiums: 7, color: '#FF8700' },
                    { rank: 5, id: 'SAI', number: 55, name: 'Carlos Sainz', team: 'Ferrari', points: 290, wins: 2, podiums: 8, color: '#DC0000' }
                ],
                constructors: [
                    { rank: 1, id: 'mclaren', name: 'McLaren', points: 666, wins: 5, color: '#FF8700' },
                    { rank: 2, id: 'ferrari', name: 'Ferrari', points: 652, wins: 5, color: '#DC0000' },
                    { rank: 3, id: 'redbull', name: 'Red Bull Racing', points: 632, wins: 9, color: '#1E41FF' },
                    { rank: 4, id: 'mercedes', name: 'Mercedes', points: 468, wins: 3, color: '#00D2BE' },
                    { rank: 5, id: 'aston', name: 'Aston Martin', points: 86, wins: 0, color: '#006F62' }
                ]
            },
            '2023': {
                drivers: [
                    { rank: 1, id: 'VER', number: 1, name: 'Max Verstappen', team: 'Red Bull Racing', points: 575, wins: 19, podiums: 21, color: '#1E41FF' },
                    { rank: 2, id: 'PER', number: 11, name: 'Sergio Perez', team: 'Red Bull Racing', points: 285, wins: 2, podiums: 9, color: '#1E41FF' },
                    { rank: 3, id: 'HAM', number: 44, name: 'Lewis Hamilton', team: 'Mercedes', points: 234, wins: 0, podiums: 6, color: '#00D2BE' },
                    { rank: 4, id: 'ALO', number: 14, name: 'Fernando Alonso', team: 'Aston Martin', points: 206, wins: 0, podiums: 8, color: '#006F62' },
                    { rank: 5, id: 'LEC', number: 16, name: 'Charles Leclerc', team: 'Ferrari', points: 206, wins: 0, podiums: 6, color: '#DC0000' }
                ],
                constructors: [
                    { rank: 1, id: 'redbull', name: 'Red Bull Racing', points: 860, wins: 21, color: '#1E41FF' },
                    { rank: 2, id: 'mercedes', name: 'Mercedes', points: 409, wins: 0, color: '#00D2BE' },
                    { rank: 3, id: 'ferrari', name: 'Ferrari', points: 406, wins: 1, color: '#DC0000' },
                    { rank: 4, id: 'mclaren', name: 'McLaren', points: 302, wins: 0, color: '#FF8700' },
                    { rank: 5, id: 'aston', name: 'Aston Martin', points: 280, wins: 0, color: '#006F62' }
                ]
            },
            '2022': {
                drivers: [
                    { rank: 1, id: 'VER', points: 454, wins: 15, podiums: 17 },
                    { rank: 2, id: 'LEC', points: 308, wins: 3, podiums: 11 },
                    { rank: 3, id: 'PER', points: 305, wins: 2, podiums: 11 },
                    { rank: 4, id: 'RUS', points: 275, wins: 1, podiums: 8 },
                    { rank: 5, id: 'SAI', points: 246, wins: 1, podiums: 9 }
                ],
                constructors: [
                    { rank: 1, id: 'redbull', name: 'Red Bull Racing', points: 759, wins: 17, color: '#1E41FF' },
                    { rank: 2, id: 'ferrari', name: 'Ferrari', points: 554, wins: 4, color: '#DC0000' },
                    { rank: 3, id: 'mercedes', name: 'Mercedes', points: 515, wins: 1, color: '#00D2BE' },
                    { rank: 4, id: 'alpine', name: 'Alpine', points: 173, wins: 0, color: '#0090FF' },
                    { rank: 5, id: 'mclaren', name: 'McLaren', points: 159, wins: 0, color: '#FF8700' }
                ]
            },
            '2021': {
                drivers: [
                    { rank: 1, id: 'VER', points: 395.5, wins: 10, podiums: 18 },
                    { rank: 2, id: 'HAM', points: 387.5, wins: 8, podiums: 17 },
                    { rank: 3, id: 'BOT', points: 226, wins: 1, podiums: 11 },
                    { rank: 4, id: 'PER', points: 190, wins: 1, podiums: 5 },
                    { rank: 5, id: 'SAI', points: 164.5, wins: 0, podiums: 4 }
                ],
                constructors: [
                    { rank: 1, id: 'mercedes', name: 'Mercedes', points: 613.5, wins: 9, color: '#00D2BE' },
                    { rank: 2, id: 'redbull', name: 'Red Bull Racing', points: 585.5, wins: 11, color: '#1E41FF' },
                    { rank: 3, id: 'ferrari', name: 'Ferrari', points: 323.5, wins: 0, color: '#DC0000' },
                    { rank: 4, id: 'mclaren', name: 'McLaren', points: 275, wins: 1, color: '#FF8700' },
                    { rank: 5, id: 'alpine', name: 'Alpine', points: 155, wins: 1, color: '#0090FF' }
                ]
            },
            '2020': {
                drivers: [
                    { rank: 1, id: 'HAM', points: 347, wins: 11, podiums: 14 },
                    { rank: 2, id: 'BOT', points: 223, wins: 2, podiums: 11 },
                    { rank: 3, id: 'VER', points: 214, wins: 2, podiums: 11 },
                    { rank: 4, id: 'PER', points: 125, wins: 1, podiums: 2 },
                    { rank: 5, id: 'RIC', points: 119, wins: 0, podiums: 2 }
                ],
                constructors: [
                    { rank: 1, id: 'mercedes', name: 'Mercedes', points: 573, wins: 13, color: '#00D2BE' },
                    { rank: 2, id: 'redbull', name: 'Red Bull Racing', points: 319, wins: 2, color: '#1E41FF' },
                    { rank: 3, id: 'mclaren', name: 'McLaren', points: 202, wins: 0, color: '#FF8700' },
                    { rank: 4, id: 'racingpoint', name: 'Racing Point', points: 195, wins: 1, color: '#006F62' },
                    { rank: 5, id: 'renault', name: 'Renault', points: 181, wins: 0, color: '#0090FF' }
                ]
            },
            '2019': {
                drivers: [
                    { rank: 1, id: 'HAM', points: 413, wins: 11, podiums: 17 },
                    { rank: 2, id: 'BOT', points: 326, wins: 4, podiums: 15 },
                    { rank: 3, id: 'VER', points: 278, wins: 3, podiums: 9 },
                    { rank: 4, id: 'LEC', points: 264, wins: 2, podiums: 10 },
                    { rank: 5, id: 'VET', points: 240, wins: 1, podiums: 9 }
                ],
                constructors: [
                    { rank: 1, id: 'mercedes', name: 'Mercedes', points: 739, wins: 15, color: '#00D2BE' },
                    { rank: 2, id: 'ferrari', name: 'Ferrari', points: 504, wins: 3, color: '#DC0000' },
                    { rank: 3, id: 'redbull', name: 'Red Bull Racing', points: 417, wins: 3, color: '#1E41FF' },
                    { rank: 4, id: 'mclaren', name: 'McLaren', points: 145, wins: 0, color: '#FF8700' },
                    { rank: 5, id: 'renault', name: 'Renault', points: 91, wins: 0, color: '#0090FF' }
                ]
            }
        };

        // Tracks with Weather Profiles
        const TRACKS = [
            { id: 'bahrain', name: 'Bahrain GP', temp: 'Hot', map: 'https://upload.wikimedia.org/wikipedia/commons/2/29/Bahrain_International_Circuit--Grand_Prix_Layout.svg' },
            { id: 'saudi', name: 'Saudi Arabian GP', temp: 'Hot', map: 'https://upload.wikimedia.org/wikipedia/commons/1/1f/Jeddah_Street_Circuit_2021.svg' },
            { id: 'australia', name: 'Australian GP', temp: 'Warm', map: 'https://upload.wikimedia.org/wikipedia/commons/7/72/Albert_Park_Circuit_2022.svg' },
            { id: 'japan', name: 'Japanese GP', temp: 'Cool', map: 'https://upload.wikimedia.org/wikipedia/commons/5/56/Suzuka_circuit_map_2005.svg' },
            { id: 'china', name: 'Chinese GP', temp: 'Mild', map: 'https://upload.wikimedia.org/wikipedia/commons/1/14/Shanghai_International_Racing_Circuit_track_map.svg' },
            { id: 'miami', name: 'Miami GP', temp: 'Hot', map: 'https://upload.wikimedia.org/wikipedia/commons/4/43/Miami_International_Autodrome_2022.svg' },
            { id: 'imola', name: 'Emilia Romagna GP', temp: 'Mild', map: 'https://upload.wikimedia.org/wikipedia/commons/2/22/Imola_2006.svg' },
            { id: 'monaco', name: 'Monaco GP', temp: 'Warm', map: 'https://upload.wikimedia.org/wikipedia/commons/3/3d/Circuit_de_Monaco_2004.svg' },
            { id: 'canada', name: 'Canadian GP', temp: 'Cool', map: 'https://upload.wikimedia.org/wikipedia/commons/e/e5/Circuit_Gilles_Villeneuve_2002.svg' },
            { id: 'spain', name: 'Spanish GP', temp: 'Warm', map: 'https://upload.wikimedia.org/wikipedia/commons/d/d8/Catalunya_2021.svg' },
            { id: 'austria', name: 'Austrian GP', temp: 'Warm', map: 'https://upload.wikimedia.org/wikipedia/commons/5/58/Red_Bull_Ring_2018.svg' },
            { id: 'britain', name: 'British GP', temp: 'Cool', rain: true, map: 'https://upload.wikimedia.org/wikipedia/commons/9/9d/Silverstone_Circuit_2020.svg' },
            { id: 'hungary', name: 'Hungarian GP', temp: 'Hot', map: 'https://upload.wikimedia.org/wikipedia/commons/9/91/Hungaroring_2003.svg' },
            { id: 'belgium', name: 'Belgian GP', temp: 'Cool', rain: true, map: 'https://upload.wikimedia.org/wikipedia/commons/1/10/Circuit_de_Spa-Francorchamps_%282018%29.svg' },
            { id: 'netherlands', name: 'Dutch GP', temp: 'Mild', map: 'https://upload.wikimedia.org/wikipedia/commons/3/3d/Circuit_Zandvoort_2020.svg' },
            { id: 'monza', name: 'Italian GP', temp: 'Warm', map: 'https://upload.wikimedia.org/wikipedia/commons/b/b8/Monza_track_map.svg' },
            { id: 'baku', name: 'Azerbaijan GP', temp: 'Warm', map: 'https://upload.wikimedia.org/wikipedia/commons/2/25/Baku_Formula_One_circuit_map.svg' },
            { id: 'singapore', name: 'Singapore GP', temp: 'Humid', map: 'https://upload.wikimedia.org/wikipedia/commons/5/5e/Marina_Bay_Street_Circuit_2023.svg' },
            { id: 'austin', name: 'United States GP', map: 'https://upload.wikimedia.org/wikipedia/commons/a/a5/Austin_circuit.svg' },
            { id: 'mexico', name: 'Mexico City GP', temp: 'Warm', map: 'https://upload.wikimedia.org/wikipedia/commons/2/2b/Aut%C3%B3dromo_Hermanos_Rodr%C3%ADguez_2015.svg' },
            { id: 'brazil', name: 'Sao Paulo GP', temp: 'Humid', rain: true, map: 'https://upload.wikimedia.org/wikipedia/commons/5/5c/Circuit_Interlagos.svg' },
            { id: 'vegas', name: 'Las Vegas GP', temp: 'Cold', map: 'https://upload.wikimedia.org/wikipedia/commons/9/96/Las_Vegas_Strip_Circuit_2023.svg' },
            { id: 'qatar', name: 'Qatar GP', temp: 'Hot', map: 'https://upload.wikimedia.org/wikipedia/commons/0/04/Lusail_International_Circuit_2023.svg' },
            { id: 'abudhabi', name: 'Abu Dhabi GP', temp: 'Warm', map: 'https://upload.wikimedia.org/wikipedia/commons/b/b0/Yas_Marina_Circuit_2021.svg' },
        ];

        // --- HELPER FUNCTIONS ---

        const getTeamColor = (teamName) => {
            if (teamName.includes('Red Bull')) return '#1E41FF';
            if (teamName.includes('Ferrari')) return '#DC0000';
            if (teamName.includes('Mercedes')) return '#00D2BE';
            if (teamName.includes('McLaren')) return '#FF8700';
            if (teamName.includes('Aston') || teamName.includes('Racing Point')) return '#006F62'; 
            if (teamName.includes('Alpine') || teamName.includes('Renault')) return '#0090FF'; 
            if (teamName.includes('Williams')) return '#005AFF';
            if (teamName.includes('RB') || teamName.includes('AlphaTauri') || teamName.includes('Toro Rosso')) return '#1634CC';
            if (teamName.includes('Sauber') || teamName.includes('Alfa')) return '#52E252'; 
            if (teamName.includes('Haas')) return '#B6BABD';
            return '#999999';
        };

        const getDriverGrid = (year) => {
            const drivers = [];
            const add = (id, name, team, num) => drivers.push({ id, name, team, number: num, color: getTeamColor(team) });

            if (year === '2025') {
                add('VER', 'Max Verstappen', 'Red Bull Racing', 1); 
                add('TSU', 'Yuki Tsunoda', 'Red Bull Racing', 22); // YUKI CONFIRMED AT RBR PER USER
                add('HAM', 'Lewis Hamilton', 'Ferrari', 44); add('LEC', 'Charles Leclerc', 'Ferrari', 16);
                add('NOR', 'Lando Norris', 'McLaren', 4); add('PIA', 'Oscar Piastri', 'McLaren', 81);
                add('RUS', 'George Russell', 'Mercedes', 63); add('ANT', 'Kimi Antonelli', 'Mercedes', 12);
                add('ALO', 'Fernando Alonso', 'Aston Martin', 14); add('STR', 'Lance Stroll', 'Aston Martin', 18);
                add('GAS', 'Pierre Gasly', 'Alpine', 10); add('DOO', 'Jack Doohan', 'Alpine', 7);
                add('ALB', 'Alexander Albon', 'Williams', 23); add('SAI', 'Carlos Sainz', 'Williams', 55);
                add('LAW', 'Liam Lawson', 'RB', 30); add('HAD', 'Isack Hadjar', 'RB', 6); // LAWSON + HADJAR AT RB
                add('HUL', 'Nico Hulkenberg', 'Sauber', 27); add('BOR', 'Gabriel Bortoleto', 'Sauber', 99);
                add('OCO', 'Esteban Ocon', 'Haas', 31); add('BEA', 'Ollie Bearman', 'Haas', 87);
            } else if (year === '2024') {
                add('VER', 'Max Verstappen', 'Red Bull Racing', 1); add('PER', 'Sergio Perez', 'Red Bull Racing', 11);
                add('HAM', 'Lewis Hamilton', 'Mercedes', 44); add('RUS', 'George Russell', 'Mercedes', 63);
                add('LEC', 'Charles Leclerc', 'Ferrari', 16); add('SAI', 'Carlos Sainz', 'Ferrari', 55);
                add('NOR', 'Lando Norris', 'McLaren', 4); add('PIA', 'Oscar Piastri', 'McLaren', 81);
                add('ALO', 'Fernando Alonso', 'Aston Martin', 14); add('STR', 'Lance Stroll', 'Aston Martin', 18);
                add('GAS', 'Pierre Gasly', 'Alpine', 10); add('OCO', 'Esteban Ocon', 'Alpine', 31);
                add('ALB', 'Alexander Albon', 'Williams', 23); add('SAR', 'Logan Sargeant', 'Williams', 2);
                add('TSU', 'Yuki Tsunoda', 'RB', 22); add('RIC', 'Daniel Ricciardo', 'RB', 3);
                add('BOT', 'Valtteri Bottas', 'Sauber', 77); add('ZHO', 'Zhou Guanyu', 'Sauber', 24);
                add('HUL', 'Nico Hulkenberg', 'Haas', 27); add('MAG', 'Kevin Magnussen', 'Haas', 20);
            } else if (year === '2023') {
                add('VER', 'Max Verstappen', 'Red Bull Racing', 1); add('PER', 'Sergio Perez', 'Red Bull Racing', 11);
                add('HAM', 'Lewis Hamilton', 'Mercedes', 44); add('RUS', 'George Russell', 'Mercedes', 63);
                add('LEC', 'Charles Leclerc', 'Ferrari', 16); add('SAI', 'Carlos Sainz', 'Ferrari', 55);
                add('ALO', 'Fernando Alonso', 'Aston Martin', 14); add('STR', 'Lance Stroll', 'Aston Martin', 18);
                add('NOR', 'Lando Norris', 'McLaren', 4); add('PIA', 'Oscar Piastri', 'McLaren', 81);
                add('GAS', 'Pierre Gasly', 'Alpine', 10); add('OCO', 'Esteban Ocon', 'Alpine', 31);
                add('ALB', 'Alexander Albon', 'Williams', 23); add('SAR', 'Logan Sargeant', 'Williams', 2);
                add('TSU', 'Yuki Tsunoda', 'AlphaTauri', 22); add('DEV', 'Nyck de Vries', 'AlphaTauri', 21);
                add('BOT', 'Valtteri Bottas', 'Alfa Romeo', 77); add('ZHO', 'Zhou Guanyu', 'Alfa Romeo', 24);
                add('HUL', 'Nico Hulkenberg', 'Haas', 27); add('MAG', 'Kevin Magnussen', 'Haas', 20);
            } else if (year === '2022') {
                add('VER', 'Max Verstappen', 'Red Bull Racing', 1); add('PER', 'Sergio Perez', 'Red Bull Racing', 11);
                add('LEC', 'Charles Leclerc', 'Ferrari', 16); add('SAI', 'Carlos Sainz', 'Ferrari', 55);
                add('HAM', 'Lewis Hamilton', 'Mercedes', 44); add('RUS', 'George Russell', 'Mercedes', 63);
                add('NOR', 'Lando Norris', 'McLaren', 4); add('RIC', 'Daniel Ricciardo', 'McLaren', 3);
                add('ALO', 'Fernando Alonso', 'Alpine', 14); add('OCO', 'Esteban Ocon', 'Alpine', 31);
                add('BOT', 'Valtteri Bottas', 'Alfa Romeo', 77); add('ZHO', 'Zhou Guanyu', 'Alfa Romeo', 24);
                add('VET', 'Sebastian Vettel', 'Aston Martin', 5); add('STR', 'Lance Stroll', 'Aston Martin', 18);
                add('GAS', 'Pierre Gasly', 'AlphaTauri', 10); add('TSU', 'Yuki Tsunoda', 'AlphaTauri', 22);
                add('MAG', 'Kevin Magnussen', 'Haas', 20); add('MSC', 'Mick Schumacher', 'Haas', 47);
                add('ALB', 'Alexander Albon', 'Williams', 23); add('LAT', 'Nicholas Latifi', 'Williams', 6);
            } else if (year === '2021') {
                add('VER', 'Max Verstappen', 'Red Bull Racing', 33); add('PER', 'Sergio Perez', 'Red Bull Racing', 11);
                add('HAM', 'Lewis Hamilton', 'Mercedes', 44); add('BOT', 'Valtteri Bottas', 'Mercedes', 77);
                add('LEC', 'Charles Leclerc', 'Ferrari', 16); add('SAI', 'Carlos Sainz', 'Ferrari', 55);
                add('NOR', 'Lando Norris', 'McLaren', 4); add('RIC', 'Daniel Ricciardo', 'McLaren', 3);
                add('VET', 'Sebastian Vettel', 'Aston Martin', 5); add('STR', 'Lance Stroll', 'Aston Martin', 18);
                add('ALO', 'Fernando Alonso', 'Alpine', 14); add('OCO', 'Esteban Ocon', 'Alpine', 31);
                add('GAS', 'Pierre Gasly', 'AlphaTauri', 10); add('TSU', 'Yuki Tsunoda', 'AlphaTauri', 22);
                add('RAI', 'Kimi Raikkonen', 'Alfa Romeo', 7); add('GIO', 'Antonio Giovinazzi', 'Alfa Romeo', 99);
                add('MSC', 'Mick Schumacher', 'Haas', 47); add('MAZ', 'Nikita Mazepin', 'Haas', 9);
                add('RUS', 'George Russell', 'Williams', 63); add('LAT', 'Nicholas Latifi', 'Williams', 6);
            } else if (year === '2020') {
                add('HAM', 'Lewis Hamilton', 'Mercedes', 44); add('BOT', 'Valtteri Bottas', 'Mercedes', 77);
                add('VER', 'Max Verstappen', 'Red Bull Racing', 33); add('ALB', 'Alexander Albon', 'Red Bull Racing', 23);
                add('VET', 'Sebastian Vettel', 'Ferrari', 5); add('LEC', 'Charles Leclerc', 'Ferrari', 16);
                add('SAI', 'Carlos Sainz', 'McLaren', 55); add('NOR', 'Lando Norris', 'McLaren', 4);
                add('RIC', 'Daniel Ricciardo', 'Renault', 3); add('OCO', 'Esteban Ocon', 'Renault', 31);
                add('PER', 'Sergio Perez', 'Racing Point', 11); add('STR', 'Lance Stroll', 'Racing Point', 18);
                add('GAS', 'Pierre Gasly', 'AlphaTauri', 10); add('KVY', 'Daniil Kvyat', 'AlphaTauri', 26);
                add('RAI', 'Kimi Raikkonen', 'Alfa Romeo', 7); add('GIO', 'Antonio Giovinazzi', 'Alfa Romeo', 99);
                add('GRO', 'Romain Grosjean', 'Haas', 8); add('MAG', 'Kevin Magnussen', 'Haas', 20);
                add('RUS', 'George Russell', 'Williams', 63); add('LAT', 'Nicholas Latifi', 'Williams', 6);
            } else if (year === '2019') {
                add('HAM', 'Lewis Hamilton', 'Mercedes', 44); add('BOT', 'Valtteri Bottas', 'Mercedes', 77);
                add('VET', 'Sebastian Vettel', 'Ferrari', 5); add('LEC', 'Charles Leclerc', 'Ferrari', 16);
                add('VER', 'Max Verstappen', 'Red Bull Racing', 33); add('GAS', 'Pierre Gasly', 'Red Bull Racing', 10);
                add('SAI', 'Carlos Sainz', 'McLaren', 55); add('NOR', 'Lando Norris', 'McLaren', 4);
                add('RIC', 'Daniel Ricciardo', 'Renault', 3); add('HUL', 'Nico Hulkenberg', 'Renault', 27);
                add('PER', 'Sergio Perez', 'Racing Point', 11); add('STR', 'Lance Stroll', 'Racing Point', 18);
                add('KVY', 'Daniil Kvyat', 'Toro Rosso', 26); add('ALB', 'Alexander Albon', 'Toro Rosso', 23);
                add('RAI', 'Kimi Raikkonen', 'Alfa Romeo', 7); add('GIO', 'Antonio Giovinazzi', 'Alfa Romeo', 99);
                add('GRO', 'Romain Grosjean', 'Haas', 8); add('MAG', 'Kevin Magnussen', 'Haas', 20);
                add('RUS', 'George Russell', 'Williams', 63); add('KUB', 'Robert Kubica', 'Williams', 88);
            }
            return drivers;
        };

        // --- COMPONENTS ---

        const Icon = ({ name, size = 20, color = "currentColor" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (window.lucide && containerRef.current) {
                    containerRef.current.innerHTML = '';
                    const i = document.createElement('i');
                    i.setAttribute('data-lucide', name);
                    containerRef.current.appendChild(i);
                    window.lucide.createIcons({ root: containerRef.current, attrs: { width: size, height: size, stroke: color } });
                }
            }, [name, size, color]);
            return <span ref={containerRef} style={{ display: 'inline-flex' }} />;
        };

        const Card = ({ title, children, className = "" }) => (
            <div className={`glass-panel rounded-xl p-4 flex flex-col h-full animate-fade-in ${className}`}>
                <div className="flex items-center justify-between mb-4">
                    <h3 className="text-[#8892b0] text-xs font-bold uppercase tracking-widest flex items-center gap-2">{title}</h3>
                    <div className="flex gap-1"><div className="w-1 h-1 bg-[#66FCF1] rounded-full"></div><div className="w-1 h-1 bg-[#66FCF1] rounded-full opacity-50"></div><div className="w-1 h-1 bg-[#66FCF1] rounded-full opacity-25"></div></div>
                </div>
                <div className="flex-1 min-h-0 relative">{children}</div>
            </div>
        );

        const Navbar = ({ activeTab, setActiveTab, selectedYear, setSelectedYear, selectedTrack, setSelectedTrack }) => {
            const tabs = [
                { id: 'overview', label: 'Overview', icon: 'layout-dashboard' },
                { id: 'telemetry', label: 'Telemetry', icon: 'activity' },
                { id: 'strategy', label: 'Strategy', icon: 'git-merge' },
                { id: 'comparison', label: 'Comparison', icon: 'users' },
                { id: 'performance', label: 'Performance', icon: 'gauge' },
                { id: 'standings', label: 'Standings', icon: 'trophy' },
                { id: 'ai_engineer', label: 'AI Engineer', icon: 'bot' }, // New Tab
            ];

            return (
                <nav className="glass-panel border-b-0 border-b-gray-800 px-6 py-3 flex flex-col md:flex-row justify-between items-center sticky top-0 z-50 gap-4 mb-6">
                    <div className="flex items-center gap-3">
                        <div className="w-8 h-8 bg-gradient-to-br from-red-600 to-red-800 rounded-md flex items-center justify-center font-black italic text-white shadow-lg shadow-red-900/50">F1</div>
                        <span className="font-bold text-xl tracking-tighter hidden sm:block text-white">DATA HUB <span className="text-[#66FCF1] text-xs font-mono font-normal align-top">PRO</span></span>
                    </div>
                    <div className="flex gap-4 items-center bg-black/30 p-1 rounded-lg border border-white/5">
                        <div className="relative group">
                             <select value={selectedYear} onChange={(e) => setSelectedYear(e.target.value)} className="bg-transparent text-white text-sm font-bold py-1 px-3 outline-none appearance-none pr-8 cursor-pointer hover:text-[#66FCF1] transition-colors">
                                {YEARS.map(y => <option key={y} value={y} className="bg-[#0B0C10]">{y}</option>)}
                            </select>
                            <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400 flex items-center"><Icon name="chevron-down" size={12} /></div>
                        </div>
                        <div className="w-px h-4 bg-gray-700"></div>
                        <div className="relative group">
                             <select value={selectedTrack?.id || ''} onChange={(e) => { const track = TRACKS.find(t => t.id == e.target.value); if(track) setSelectedTrack(track); }} className="bg-transparent text-white text-sm font-bold py-1 px-3 outline-none appearance-none pr-8 cursor-pointer min-w-[160px] max-w-[200px] hover:text-[#66FCF1] transition-colors">
                                {TRACKS.map(t => <option key={t.id} value={t.id} className="bg-[#0B0C10]">{t.name}</option>)}
                            </select>
                            <div className="absolute right-2 top-1/2 -translate-y-1/2 pointer-events-none text-gray-400 flex items-center"><Icon name="chevron-down" size={12} /></div>
                        </div>
                    </div>
                    <div className="flex gap-1 bg-black/30 p-1 rounded-lg overflow-x-auto max-w-full border border-white/5">
                        {tabs.map(tab => (
                            <button key={tab.id} onClick={() => setActiveTab(tab.id)} className={`flex items-center gap-2 px-3 py-1.5 rounded-md text-xs font-bold transition-all whitespace-nowrap ${activeTab === tab.id ? 'bg-[#66FCF1] text-black shadow-[0_0_15px_rgba(102,252,241,0.3)]' : 'text-gray-400 hover:text-white hover:bg-white/5'}`}>
                                <Icon name={tab.icon} size={14} />{tab.label}
                            </button>
                        ))}
                    </div>
                </nav>
            );
        };

        const WeatherWidget = ({ track }) => {
            const weather = useMemo(() => {
                let airTemp = 22, humidity = 45, rainChance = 10;
                if (track.temp === 'Hot') { airTemp = 32; humidity = 30; }
                if (track.temp === 'Cool') { airTemp = 16; humidity = 60; }
                if (track.temp === 'Humid') { airTemp = 29; humidity = 85; rainChance = 40; }
                if (track.rain) { rainChance = 85; humidity = 75; }
                return {
                    air: airTemp + Math.floor(Math.random() * 4 - 2),
                    track: airTemp + 15 + Math.floor(Math.random() * 8 - 4),
                    humidity: humidity + Math.floor(Math.random() * 10 - 5),
                    rain: rainChance
                };
            }, [track]);

            return (
                <Card title="Live Weather" className="h-full">
                    <div className="grid grid-cols-2 gap-4 h-full items-center">
                        <div className="flex flex-col items-center">
                            <Icon name={weather.rain > 60 ? "cloud-rain" : "sun"} size={32} color={weather.rain > 60 ? "#0090FF" : "#ffe600"} />
                            <span className="text-2xl font-bold text-white mt-2">{weather.air}°C</span>
                            <span className="text-xs text-gray-500 uppercase tracking-wider">Air Temp</span>
                        </div>
                        <div className="space-y-3">
                            <div className="flex justify-between text-sm border-b border-gray-800 pb-1"><span className="text-gray-400">Track</span><span className="font-mono text-[#ff3333]">{weather.track}°C</span></div>
                            <div className="flex justify-between text-sm border-b border-gray-800 pb-1"><span className="text-gray-400">Humidity</span><span className="font-mono text-[#66FCF1]">{weather.humidity}%</span></div>
                            <div className="flex justify-between text-sm"><span className="text-gray-400">Rain %</span><span className="font-mono text-blue-400">{weather.rain}%</span></div>
                        </div>
                    </div>
                </Card>
            );
        };

        const RaceControlTicker = () => {
            const [msg, setMsg] = useState("GREEN FLAG");
            const messages = ["GREEN FLAG", "DRS ENABLED", "YELLOW FLAG SECTOR 2", "CAR 14 TRACK LIMITS T9", "PIT WINDOW OPEN", "BLUE FLAG CAR 22"];
            useEffect(() => {
                const interval = setInterval(() => setMsg(messages[Math.floor(Math.random() * messages.length)]), 4000);
                return () => clearInterval(interval);
            }, []);
            return (
                <div className="bg-black border-b-2 border-[#66FCF1] p-2 overflow-hidden relative flex items-center">
                    <div className="bg-[#66FCF1] text-black font-bold px-2 py-0.5 text-xs rounded mr-4 shrink-0 animate-pulse">RACE CONTROL</div>
                    <div className="font-mono text-sm text-white whitespace-nowrap animate-fade-in key={msg}">{msg}</div>
                </div>
            );
        };

        // --- AI ENGINEER VIEW ---
        const AIEngineerView = ({ year, track, drivers }) => {
            const [input, setInput] = useState("");
            const [messages, setMessages] = useState([
                { role: 'ai', text: `Radio check. I'm your AI Race Engineer. We are at ${track.name}, looking at the ${year} season data. How can I help?` }
            ]);
            const [loading, setLoading] = useState(false);
            const messagesEndRef = useRef(null);

            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };

            useEffect(scrollToBottom, [messages]);

            const handleSend = async () => {
                if (!input.trim()) return;
                const userMsg = input;
                setInput("");
                setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
                setLoading(true);

                // Prepare Context
                const weather = { air: 25, track: 35, rain: 10 }; // Mock weather for context
                const topDrivers = drivers.slice(0, 3);
                const contextData = { year, track, weather, topDrivers };

                const response = await callGemini(userMsg, contextData);
                setMessages(prev => [...prev, { role: 'ai', text: response }]);
                setLoading(false);
            };

            const quickActions = [
                "✨ Analyze Strategy",
                "✨ Predict Undercut",
                "✨ Summarize Battle"
            ];

            return (
                <div className="grid grid-cols-1 lg:grid-cols-4 gap-6 h-full">
                    <div className="lg:col-span-3 flex flex-col h-full">
                        <Card title="Team Radio Channel" className="flex-1 flex flex-col">
                            <div className="flex-1 overflow-y-auto p-4 space-y-4 mb-4 bg-black/20 rounded-lg border border-white/5">
                                {messages.map((m, i) => (
                                    <div key={i} className={`flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`chat-bubble ${m.role === 'user' ? 'chat-user text-right' : 'chat-ai text-left'}`}>
                                            <div className={`text-xs font-bold mb-1 ${m.role === 'user' ? 'text-[#66FCF1]' : 'text-gray-400'}`}>
                                                {m.role === 'user' ? 'DRIVER' : 'ENGINEER'}
                                            </div>
                                            <div dangerouslySetInnerHTML={{ __html: marked.parse(m.text) }} />
                                        </div>
                                    </div>
                                ))}
                                {loading && (
                                    <div className="flex justify-start">
                                        <div className="chat-bubble chat-ai">
                                            <div className="flex items-center">
                                                <span className="typing-dot"></span>
                                                <span className="typing-dot"></span>
                                                <span className="typing-dot"></span>
                                            </div>
                                        </div>
                                    </div>
                                )}
                                <div ref={messagesEndRef} />
                            </div>
                            <div className="flex gap-2">
                                <input 
                                    type="text" 
                                    value={input}
                                    onChange={(e) => setInput(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleSend()}
                                    placeholder="Ask about strategy, telemetry, or rules..."
                                    className="flex-1 bg-[#1F2833] text-white p-3 rounded-lg border border-gray-700 focus:border-[#66FCF1] outline-none"
                                />
                                <button 
                                    onClick={handleSend}
                                    disabled={loading}
                                    className="bg-[#66FCF1] text-black font-bold px-6 py-3 rounded-lg hover:bg-[#45A29E] transition-colors disabled:opacity-50"
                                >
                                    <Icon name="send" size={18} />
                                </button>
                            </div>
                        </Card>
                    </div>
                    <div className="lg:col-span-1 h-full">
                        <Card title="Quick Commands">
                            <div className="flex flex-col gap-3">
                                {quickActions.map((action, i) => (
                                    <button 
                                        key={i}
                                        onClick={() => { setInput(action.replace('✨ ', '')); handleSend(); }}
                                        className="text-left p-3 rounded-lg bg-white/5 hover:bg-[#66FCF1]/10 border border-white/10 hover:border-[#66FCF1] transition-all text-sm font-medium text-white flex items-center gap-2 group"
                                    >
                                        <span className="text-xl group-hover:scale-110 transition-transform">✨</span>
                                        {action.replace('✨ ', '')}
                                    </button>
                                ))}
                            </div>
                            <div className="mt-6 p-4 bg-blue-900/20 border border-blue-500/30 rounded-lg">
                                <div className="flex items-center gap-2 text-blue-400 text-xs font-bold uppercase mb-2">
                                    <Icon name="info" size={14} /> System Status
                                </div>
                                <div className="text-xs text-gray-400">
                                    Connected to Pitwall Neural Net. Latency: 24ms. Encryption: AES-256.
                                </div>
                            </div>
                        </Card>
                    </div>
                </div>
            );
        };

        // --- DASHBOARD VIEWS ---

        const PerformanceView = ({ drivers }) => {
            const performanceData = useMemo(() => drivers.map(d => {
                let topSpeed = 320, cornering = 150; 
                if(d.team.includes('Red Bull')) { topSpeed += 25; cornering += 30; }
                else if(d.team.includes('Ferrari')) { topSpeed += 20; cornering += 25; }
                else if(d.team.includes('McLaren')) { topSpeed += 18; cornering += 28; }
                else { topSpeed += Math.random() * 10; cornering += Math.random() * 10; }
                return { ...d, topSpeed: Math.floor(topSpeed + Math.random()*2), cornering: Math.floor(cornering + Math.random()*2) };
            }), [drivers]);

            return (
                <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 h-full">
                    <Card title="Performance Matrix">
                         <ResponsiveContainer width="100%" height="100%">
                            <ScatterChart margin={{ top: 20, right: 20, bottom: 20, left: 20 }}>
                                <CartesianGrid strokeDasharray="3 3" stroke="#333" />
                                <XAxis type="number" dataKey="cornering" name="Cornering" unit=" km/h" stroke="#666" domain={['auto', 'auto']} />
                                <YAxis type="number" dataKey="topSpeed" name="Top Speed" unit=" km/h" stroke="#666" domain={['auto', 'auto']} />
                                <Tooltip cursor={{ strokeDasharray: '3 3' }} contentStyle={{ backgroundColor: '#1F2833', border: '1px solid #45A29E' }} />
                                <Scatter name="Drivers" data={performanceData} fill="#8884d8">
                                    {performanceData.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.color} />)}
                                </Scatter>
                            </ScatterChart>
                        </ResponsiveContainer>
                    </Card>
                    <div className="grid grid-cols-1 gap-6">
                        <div className="grid grid-cols-2 gap-6">
                            <Card title="G-Force Envelope">
                                <div className="flex items-center justify-center h-full">
                                    <div className="relative w-full aspect-square max-w-[200px] border-2 border-dashed border-gray-700 rounded-full flex items-center justify-center">
                                        <div className="absolute w-full h-[1px] bg-gray-700"></div>
                                        <div className="absolute h-full w-[1px] bg-gray-700"></div>
                                        {performanceData.slice(0,5).map((d, i) => (
                                            <div key={i} className="absolute w-2 h-2 rounded-full" style={{ backgroundColor: d.color, top: `${50 + (Math.random() * 40 - 20)}%`, left: `${50 + (Math.random() * 40 - 20)}%`, opacity: 0.8 }}></div>
                                        ))}
                                        <span className="absolute bottom-2 text-[10px] text-gray-500">Lateral G</span>
                                    </div>
                                </div>
                            </Card>
                            <Card title="Corner Analysis Breakdown">
                                <div className="overflow-y-auto h-full">
                                    <table className="w-full text-xs">
                                        <thead className="text-gray-500 border-b border-gray-700">
                                            <tr><th className="text-left p-1">Driver</th><th className="text-right p-1">Low</th><th className="text-right p-1">Med</th><th className="text-right p-1">High</th></tr>
                                        </thead>
                                        <tbody>
                                            {performanceData.slice(0, 8).map(d => (
                                                <tr key={d.id} className="border-b border-white/5">
                                                    <td className="p-1 font-bold" style={{color: d.color}}>{d.id}</td>
                                                    <td className="p-1 text-right text-gray-400">{Math.floor(d.cornering * 0.6)}</td>
                                                    <td className="p-1 text-right text-gray-400">{Math.floor(d.cornering * 1.2)}</td>
                                                    <td className="p-1 text-right text-white">{Math.floor(d.cornering * 1.8)}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </Card>
                        </div>
                    </div>
                </div>
            );
        };

        const StandingsView = ({ year, drivers }) => {
            const [viewType, setViewType] = useState('drivers');
            const data = useMemo(() => {
                let driverStandings = [...drivers];
                
                if (HISTORICAL_DATA[year]) {
                    const realStats = HISTORICAL_DATA[year].drivers;
                    driverStandings = driverStandings.map(d => {
                        const stats = realStats.find(r => r.id === d.id);
                        if (stats) return { ...d, ...stats };
                        // Fill non-top-5 with realistic looking data
                        const seed = d.number * 123;
                        const pts = Math.max(0, Math.floor(100 - (Math.random() * 80))); 
                        return { ...d, points: pts, wins: 0, podiums: 0 };
                    });
                } else {
                    // Fallback Simulation for years not in HISTORICAL_DATA if any
                    driverStandings = driverStandings.map(d => {
                        let base = 50;
                        if(d.team.includes('Red Bull') || d.team.includes('Ferrari')) base = 300;
                        return { ...d, points: Math.floor(base + Math.random()*100), wins: Math.floor(Math.random()*5), podiums: Math.floor(Math.random()*10) };
                    });
                }

                // 2. Sort
                driverStandings.sort((a, b) => b.points - a.points);
                // 3. Assign Rank
                driverStandings = driverStandings.map((d, i) => ({ ...d, rank: i + 1 }));

                // 4. Construct Team Standings Logic
                const teamMap = {};
                driverStandings.forEach(d => {
                    if(!teamMap[d.team]) teamMap[d.team] = { name: d.team, points: 0, wins: 0, color: d.color };
                    teamMap[d.team].points += d.points;
                    teamMap[d.team].wins += d.wins;
                });
                const constructorStandings = Object.values(teamMap).sort((a,b) => b.points - a.points).map((c,i) => ({...c, rank: i+1}));

                // 5. Generate History for Charts
                const totalRounds = 24;
                const genHist = (entities) => {
                    const hist = Array.from({ length: totalRounds }, (_, i) => ({ round: i + 1 }));
                    entities.slice(0,5).forEach(e => {
                        const final = e.points;
                        hist.forEach((h, idx) => {
                            const p = (idx + 1) / totalRounds;
                            h[e.id || e.name] = Math.floor(final * Math.pow(p, 1.2));
                        });
                    });
                    return hist;
                };

                return { 
                    drivers: driverStandings, 
                    constructors: constructorStandings, 
                    driverHistory: genHist(driverStandings), 
                    constructorHistory: genHist(constructorStandings) 
                };
            }, [year, drivers]);

            const entities = viewType === 'drivers' ? data.drivers : data.constructors;
            const history = viewType === 'drivers' ? data.driverHistory : data.constructorHistory;
            const winData = entities.filter(e => e.wins > 0);

            return (
                <div className="h-full flex flex-col gap-4">
                    <div className="flex gap-4 justify-center mb-4">
                        <button onClick={() => setViewType('drivers')} className={`px-6 py-2 rounded-full font-bold text-sm transition-all ${viewType === 'drivers' ? 'bg-[#e10600] text-white' : 'bg-gray-800 text-gray-400'}`}>DRIVER STANDINGS</button>
                        <button onClick={() => setViewType('constructors')} className={`px-6 py-2 rounded-full font-bold text-sm transition-all ${viewType === 'constructors' ? 'bg-[#e10600] text-white' : 'bg-gray-800 text-gray-400'}`}>CONSTRUCTOR STANDINGS</button>
                    </div>

                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                        <div className="lg:col-span-2 h-full overflow-hidden flex flex-col">
                             <Card title={`Championship Standings - ${year}`}>
                                <div className="overflow-y-auto h-full pr-2">
                                    <table className="w-full standings-table text-sm">
                                        <thead><tr><th>Pos</th><th>Name</th><th className="text-right">Points</th></tr></thead>
                                        <tbody>
                                            {entities.map((e) => (
                                                <tr key={e.rank}>
                                                    <td className="font-mono text-[#66FCF1]">{e.rank}</td>
                                                    <td><div className="flex items-center gap-2"><div className="w-1 h-4" style={{backgroundColor: e.color}}></div>{e.name}</div></td>
                                                    <td className="text-right font-mono">{e.points}</td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </Card>
                        </div>

                        <div className="flex flex-col gap-6">
                            {history && history.length > 0 && (
                                <Card title="Season Progression">
                                    <ResponsiveContainer width="100%" height={200}>
                                        <LineChart data={history}>
                                            <XAxis dataKey="round" stroke="#666" />
                                            <YAxis stroke="#666" width={30} tick={{fontSize: 10}} />
                                            <Tooltip contentStyle={{backgroundColor:'#1F2833'}}/>
                                            {entities.slice(0,5).map(e => <Line key={e.name} type="monotone" dataKey={e.id||e.name} stroke={e.color} dot={false} />)}
                                        </LineChart>
                                    </ResponsiveContainer>
                                </Card>
                            )}
                            
                            <div className="grid grid-cols-1 gap-4 h-full">
                                <div className="grid grid-cols-2 gap-4">
                                    <Card title="Leader">
                                        <div className="flex flex-col items-center justify-center h-full">
                                            <div className="text-2xl font-black text-white text-center">{entities[0]?.name.split(' ').pop()}</div>
                                            <div className="text-[#66FCF1] font-mono text-sm">{entities[0]?.points} PTS</div>
                                        </div>
                                    </Card>
                                    <Card title="Gap">
                                        <div className="flex flex-col items-center justify-center h-full">
                                            <div className="text-2xl font-mono text-white">+{entities[0]?.points - (entities[1]?.points || 0)}</div>
                                            <div className="text-gray-500 text-xs">POINTS</div>
                                        </div>
                                    </Card>
                                </div>
                                <Card title="Victory Share (Top 5)">
                                    <div className="flex items-center justify-center h-full">
                                        <ResponsiveContainer width="100%" height={150}>
                                            <PieChart>
                                                <Pie data={winData} cx="50%" cy="50%" innerRadius={40} outerRadius={60} paddingAngle={5} dataKey="wins">
                                                    {winData.map((entry, index) => <Cell key={`cell-${index}`} fill={entry.color} stroke="rgba(0,0,0,0.5)" />)}
                                                </Pie>
                                                <Tooltip contentStyle={{ backgroundColor: '#1F2833', borderRadius: '8px' }} itemStyle={{color: '#fff'}} />
                                            </PieChart>
                                        </ResponsiveContainer>
                                    </div>
                                </Card>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const TelemetryView = ({ data, drivers }) => {
            const [selected, setSelected] = useState([drivers[0]?.id, drivers[1]?.id]);
            const toggle = (id) => setSelected(prev => prev.includes(id) ? prev.filter(x => x !== id) : [...prev, id].slice(0,4));

            return (
                <div className="grid grid-cols-1 lg:grid-cols-4 gap-6 h-full">
                    <div className="lg:col-span-3 flex flex-col gap-6">
                        <Card title="Speed Trace">
                            <ResponsiveContainer width="100%" height="100%">
                                <LineChart data={data}>
                                    <XAxis dataKey="distance" hide />
                                    <YAxis domain={['auto','auto']} stroke="#666"/>
                                    <Tooltip contentStyle={{backgroundColor:'#1F2833'}}/>
                                    {selected.map(id => {
                                        const d = drivers.find(x => x.id === id);
                                        return d ? <Line key={id} type="monotone" dataKey={`${id}_speed`} stroke={d.color} dot={false} /> : null;
                                    })}
                                </LineChart>
                            </ResponsiveContainer>
                        </Card>
                         <div className="grid grid-cols-2 gap-6 h-64">
                            <Card title="Throttle">
                                <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={data}>
                                        <XAxis dataKey="distance" hide />
                                        <YAxis domain={[0,100]} hide />
                                        <Tooltip contentStyle={{backgroundColor:'#1F2833'}}/>
                                        {selected.map(id => {
                                            const d = drivers.find(x => x.id === id);
                                            return d ? <Line key={id} type="step" dataKey={`${id}_throttle`} stroke={d.color} dot={false} /> : null;
                                        })}
                                    </LineChart>
                                </ResponsiveContainer>
                            </Card>
                             <Card title="Brake">
                                <ResponsiveContainer width="100%" height="100%">
                                    <LineChart data={data}>
                                        <XAxis dataKey="distance" hide />
                                        <YAxis domain={[0,100]} hide />
                                        <Tooltip contentStyle={{backgroundColor:'#1F2833'}}/>
                                        {selected.map(id => {
                                            const d = drivers.find(x => x.id === id);
                                            return d ? <Line key={id} type="monotone" dataKey={`${id}_brake`} stroke={d.color} dot={false} /> : null;
                                        })}
                                    </LineChart>
                                </ResponsiveContainer>
                            </Card>
                         </div>
                    </div>
                    <Card title="Drivers">
                        <div className="overflow-y-auto h-full space-y-2">
                            {drivers.map(d => (
                                <button key={d.id} onClick={() => toggle(d.id)} className={`w-full p-2 rounded flex justify-between text-sm ${selected.includes(d.id) ? 'bg-[#66FCF1]/20' : 'hover:bg-white/5'}`}>
                                    <span style={{color: d.color}}>{d.name}</span>
                                    {selected.includes(d.id) && <Icon name="check" size={14} />}
                                </button>
                            ))}
                        </div>
                    </Card>
                </div>
            );
        };
        
        const StrategyView = ({ lapData, stintData }) => (
            <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full">
                <div className="lg:col-span-3 h-48">
                    <Card title="Tyre Stints">
                        <div className="overflow-y-auto h-full px-4">
                            {stintData.slice(0,8).map((d,i) => (
                                <div key={i} className="flex items-center gap-4 mb-2">
                                    <span className="w-8 text-xs font-bold text-white">{d.driver}</span>
                                    <div className="flex-1 h-6 bg-gray-800 rounded flex overflow-hidden">
                                        {d.stints.map((s, idx) => <div key={idx} style={{width: `${((s.end-s.start)/53)*100}%`, backgroundColor: s.tyre==='S'?'#ff3333':s.tyre==='M'?'#ffe600':'#fff'}} className="h-full border-r border-black/20" />)}
                                    </div>
                                </div>
                            ))}
                        </div>
                    </Card>
                </div>
                <div className="lg:col-span-2 h-64">
                    <Card title="Gap to Leader">
                         <ResponsiveContainer width="100%" height="100%">
                            <AreaChart data={lapData}>
                                <defs><linearGradient id="colorGap" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#66FCF1" stopOpacity={0.8}/><stop offset="95%" stopColor="#66FCF1" stopOpacity={0}/></linearGradient></defs>
                                <XAxis dataKey="lap" stroke="#666" />
                                <YAxis hide />
                                <Tooltip contentStyle={{ backgroundColor: '#1F2833' }}/>
                                <Area type="monotone" dataKey="time" stroke="#66FCF1" fillOpacity={1} fill="url(#colorGap)" />
                            </AreaChart>
                        </ResponsiveContainer>
                    </Card>
                </div>
                <div className="h-64">
                     <Card title="Predictions">
                         <div className="flex flex-col gap-4 p-2">
                             <div className="flex justify-between border-b border-white/10 pb-2"><span className="text-gray-400 text-sm">Pit Window</span><span className="text-[#66FCF1] font-mono">L22-25</span></div>
                             <div className="flex justify-between border-b border-white/10 pb-2"><span className="text-gray-400 text-sm">Undercut</span><span className="text-red-500 font-mono">High</span></div>
                             <div className="flex justify-between border-b border-white/10 pb-2"><span className="text-gray-400 text-sm">Rain Prob</span><span className="text-blue-400 font-mono">12%</span></div>
                         </div>
                     </Card>
                </div>
            </div>
        );

        const ComparisonView = ({ drivers }) => {
            const [d1, setD1] = useState(drivers[0]);
            const [d2, setD2] = useState(drivers[1]);
            useEffect(() => { setD1(drivers[0]); setD2(drivers[1]); }, [drivers]);
            if(!d1 || !d2) return <div>Loading...</div>;
            
            const data = [
                { subject: 'Pace', A: 120, B: 110 }, { subject: 'Tyre', A: 90, B: 130 },
                { subject: 'Racecraft', A: 100, B: 95 }, { subject: 'Consistency', A: 85, B: 90 }
            ];

            return (
                <div className="grid grid-cols-2 gap-6 h-full">
                    <Card title="Head to Head">
                        <div className="flex justify-between mb-4 px-4">
                            <select className="bg-black text-white p-2 rounded text-sm" value={d1.id} onChange={e => setD1(drivers.find(d=>d.id===e.target.value))}>{drivers.map(d=><option key={d.id} value={d.id}>{d.name}</option>)}</select>
                            <select className="bg-black text-white p-2 rounded text-sm" value={d2.id} onChange={e => setD2(drivers.find(d=>d.id===e.target.value))}>{drivers.map(d=><option key={d.id} value={d.id}>{d.name}</option>)}</select>
                        </div>
                        <ResponsiveContainer width="100%" height="80%">
                            <RadarChart outerRadius={90} data={data}>
                                <PolarGrid stroke="#333" />
                                <PolarAngleAxis dataKey="subject" tick={{fill:'#999', fontSize: 10}} />
                                <Radar name={d1.name} dataKey="A" stroke={d1.color} fill={d1.color} fillOpacity={0.3} />
                                <Radar name={d2.name} dataKey="B" stroke={d2.color} fill={d2.color} fillOpacity={0.3} />
                                <Legend />
                            </RadarChart>
                        </ResponsiveContainer>
                    </Card>
                    <div className="flex flex-col gap-6">
                         <div className="grid grid-cols-2 gap-4">
                            <div className="bg-white/5 p-3 rounded border-l-2" style={{borderColor: d1.color}}>
                                <div className="text-xs text-gray-500">BEST LAP</div>
                                <div className="font-mono text-white text-lg">1:23.405</div>
                            </div>
                            <div className="bg-white/5 p-3 rounded border-l-2" style={{borderColor: d2.color}}>
                                <div className="text-xs text-gray-500">BEST LAP</div>
                                <div className="font-mono text-white text-lg">1:23.512</div>
                            </div>
                            <div className="bg-white/5 p-3 rounded border-l-2" style={{borderColor: d1.color}}>
                                <div className="text-xs text-gray-500">AVG SPEED</div>
                                <div className="font-mono text-white text-lg">234 KM/H</div>
                            </div>
                            <div className="bg-white/5 p-3 rounded border-l-2" style={{borderColor: d2.color}}>
                                <div className="text-xs text-gray-500">AVG SPEED</div>
                                <div className="font-mono text-white text-lg">233 KM/H</div>
                            </div>
                         </div>
                         <Card title="Lap Time Distribution">
                             <ResponsiveContainer width="100%" height="100%">
                                 <BarChart data={[{range:'1:23', [d1.id]: 5, [d2.id]: 4}, {range:'1:24', [d1.id]: 15, [d2.id]: 18}]}>
                                     <XAxis dataKey="range" stroke="#666" />
                                     <Tooltip contentStyle={{backgroundColor: '#1F2833'}} />
                                     <Bar dataKey={d1.id} fill={d1.color} />
                                     <Bar dataKey={d2.id} fill={d2.color} />
                                 </BarChart>
                             </ResponsiveContainer>
                         </Card>
                    </div>
                </div>
            );
        };

        const Leaderboard = ({ drivers }) => (
            <Card title="Live Standings">
                <div className="overflow-y-auto pr-2 h-full">
                    <table className="w-full text-sm standings-table">
                        <thead><tr><th>Pos</th><th>Driver</th><th>Gap</th></tr></thead>
                        <tbody>
                            {drivers.slice(0,10).map((d,i) => (
                                <tr key={d.id}>
                                    <td className="text-[#66FCF1]">{i+1}</td>
                                    <td>{d.name}</td>
                                    <td className="text-right font-mono text-gray-400">{i===0 ? 'Leader' : `+${(Math.random()*2).toFixed(3)}`}</td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </Card>
        );

        const App = () => {
            const [activeTab, setActiveTab] = useState('overview');
            const [selectedYear, setSelectedYear] = useState('2025');
            const [selectedTrack, setSelectedTrack] = useState(TRACKS[0]);
            const [mapError, setMapError] = useState(false);

            const currentDrivers = useMemo(() => getDriverGrid(selectedYear), [selectedYear]);

            useEffect(() => { setMapError(false); }, [selectedTrack]);

            // Generate Mock Data for Charts
            const telemetryData = useMemo(() => {
                return Array.from({length: 100}, (_, i) => {
                    const pt = { distance: i };
                    currentDrivers.forEach(d => {
                        pt[`${d.id}_speed`] = 200 + Math.random()*100;
                        pt[`${d.id}_throttle`] = 50 + Math.random()*50;
                        pt[`${d.id}_brake`] = Math.random()*50;
                    });
                    return pt;
                });
            }, [currentDrivers]);

            const lapData = useMemo(() => {
                return currentDrivers.flatMap(d => Array.from({length: 20}, (_, i) => ({
                    driver: d.id, lap: i+1, time: 80 + Math.random()*5
                })));
            }, [currentDrivers]);

            const stintData = useMemo(() => currentDrivers.map(d => ({
                driver: d.id, stints: [{start:1, end:20, tyre:'M'}, {start:21, end:50, tyre:'H'}]
            })), [currentDrivers]);

            return (
                <div className="min-h-screen bg-[#050505] pb-8 flex flex-col">
                    <RaceControlTicker />
                    <Navbar 
                        activeTab={activeTab} 
                        setActiveTab={setActiveTab} 
                        selectedYear={selectedYear}
                        setSelectedYear={setSelectedYear}
                        selectedTrack={selectedTrack}
                        setSelectedTrack={setSelectedTrack}
                    />
                    
                    <main className="container mx-auto px-6 py-2 flex-1 h-[calc(100vh-140px)]">
                        {activeTab === 'overview' && (
                            <div className="grid grid-cols-1 lg:grid-cols-4 gap-6 h-full">
                                <div className="lg:col-span-3 h-full flex flex-col gap-6">
                                    <Card title="Live Circuit Telemetry" className="flex-1">
                                        <div className="w-full h-full flex items-center justify-center relative overflow-hidden group">
                                            {!mapError ? (
                                                <img 
                                                    src={selectedTrack.map} 
                                                    alt={selectedTrack.name}
                                                    className="absolute inset-0 w-full h-full object-contain p-8 opacity-80 group-hover:opacity-100 transition-all duration-700"
                                                    style={{ filter: 'invert(1) drop-shadow(0 0 8px rgba(102, 252, 241, 0.3))' }}
                                                    onError={() => setMapError(true)}
                                                />
                                            ) : (
                                                <div className="flex flex-col items-center text-gray-500">
                                                    <Icon name="map-pin-off" size={32} />
                                                    <span>Map Data Unavailable</span>
                                                </div>
                                            )}
                                            <div className="absolute top-4 left-4">
                                                <h1 className="text-5xl font-black italic text-white uppercase tracking-tighter neon-text">{selectedTrack.name}</h1>
                                                <div className="text-[#66FCF1] font-mono text-sm mt-1">FIA GRADE 1 // {selectedYear} SPEC</div>
                                            </div>
                                        </div>
                                    </Card>
                                    <div className="h-64 grid grid-cols-3 gap-6">
                                        <div className="col-span-1"><WeatherWidget track={selectedTrack} /></div>
                                        <div className="col-span-2"><Card title="Top 3"><div className="flex flex-col gap-2">{currentDrivers.slice(0,3).map((d,i)=><div key={d.id} className="flex justify-between p-2 bg-white/5 rounded border border-white/5"><span className="text-[#66FCF1] font-mono">{i+1}</span><span style={{color:d.color}}>{d.name}</span><span className="font-mono text-white">1:24.{Math.floor(Math.random()*900)}</span></div>)}</div></Card></div>
                                    </div>
                                </div>
                                <div className="h-full flex flex-col gap-6">
                                    <div className="h-1/2"><Leaderboard drivers={currentDrivers} /></div>
                                    <div className="h-1/2"><Card title="Status"><div className="flex h-full items-center justify-center flex-col"><div className="w-20 h-20 border-4 border-green-500 rounded-full flex items-center justify-center animate-pulse text-green-500 font-bold text-2xl">G</div><span className="mt-2 text-white font-bold">TRACK CLEAR</span></div></Card></div>
                                </div>
                            </div>
                        )}
                        
                        {activeTab === 'telemetry' && <TelemetryView data={telemetryData} drivers={currentDrivers} />}
                        {activeTab === 'strategy' && <StrategyView lapData={lapData} stintData={stintData} drivers={currentDrivers} />}
                        {activeTab === 'comparison' && <ComparisonView drivers={currentDrivers} />}
                        {activeTab === 'performance' && <PerformanceView drivers={currentDrivers} />}
                        {activeTab === 'standings' && <StandingsView year={selectedYear} drivers={currentDrivers} />}
                        {activeTab === 'ai_engineer' && <AIEngineerView year={selectedYear} track={selectedTrack} drivers={currentDrivers} />}
                    </main>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
